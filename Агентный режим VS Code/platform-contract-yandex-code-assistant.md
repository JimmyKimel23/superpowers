# Platform Contract: Yandex Code Assistant
## Версия: 1.0 (2026-02-26)

> **Назначение:** Формализованный контракт с платформой — что она предоставляет, что ограничивает, какой бюджет контекста доступен. Источник правды для архитектурных решений.

---

## 1. Сборка системного промпта

Платформа собирает финальный промпт из 5 секций в фиксированном порядке:

```
┌─────────────────────────────────────────────────────────┐
│ 1. ROLE DEFINITION                                       │
│    Встроенное определение режима + наше roleDefinition   │
├──────────────────────────────────────────────────────────┤
│ 2. MARKDOWN RULES                                        │
│    Ссылки на файлы и language constructs = кликабельные  │
├──────────────────────────────────────────────────────────┤
│ 3. TOOL USE                                              │
│    Определения всех инструментов + жёсткие правила       │
│    ⚠ Приоритет над нашими custom instructions            │
├──────────────────────────────────────────────────────────┤
│ 4. SYSTEM INFORMATION                                    │
│    ОС, shell, workspace path                             │
├──────────────────────────────────────────────────────────┤
│ 5. USER'S CUSTOM INSTRUCTIONS                            │
│    "should be followed to the best of your ability       │
│     without interfering with the TOOL USE guidelines"    │
│    ├── Custom Instructions for All Modes  → Слой 1       │
│    ├── Mode-specific Custom Instructions  → Слой 2       │
│    └── ALL .mdc files from rules/         → Слой 3       │
└─────────────────────────────────────────────────────────┘
```

**Ключевой факт:** Все .mdc файлы из `.codeassistant/rules/` загружаются в промпт КАЖДОГО режима. Поля `alwaysApply` и `globs` во frontmatter **не контролируют загрузку** — они могут влиять на то, как модель интерпретирует применимость, но текст всегда в контексте.

**Верифицировано:** экспорт системного промпта Architect Mode содержит все 11 .mdc файлов целиком (8 workflows + 3 rules).

**Требует проверки:** ведут ли себя другие режимы так же (предположение: да, механизм загрузки единый).

---

## 2. Бюджет контекста (Context Budget)

### Фиксированные затраты (каждый запрос, каждый режим)

| Компонент | Объём (байт) | Оценка (токенов) | Примечание |
|-----------|-------------|-------------------|------------|
| Platform sections (Tool Use, Rules format, System Info, Objective) | ~35 000 | ~8 750 | Включает описания всех инструментов |
| Слой 1 (Custom Instructions for All Modes) | ~5 000 | ~1 250 | 9 принципов + протоколы |
| Слой 2 (Mode-specific instructions) | 4 000–9 200 | 1 000–2 300 | Зависит от режима |
| **Слой 3 (ВСЕ .mdc файлы)** | **214 925** | **~53 700** | **⚠ Главная статья расхода** |
| **ИТОГО фиксированные** | **~260 000** | **~65 000** | **До первого слова пользователя** |

### Детализация Слоя 3 (по файлам)

| Файл | Байт | ~Токенов | % от Слоя 3 |
|------|------|----------|-------------|
| workflow-ako-validation.mdc | 34 029 | 8 507 | 15.8% |
| workflow-gifts-hospitality.mdc | 27 409 | 6 852 | 12.8% |
| workflow-doc-coauthoring.mdc | 26 712 | 6 678 | 12.4% |
| workflow-development.mdc | 26 156 | 6 539 | 12.2% |
| workflow-ticket-recon.mdc | 25 819 | 6 455 | 12.0% |
| workflow-sponsorship.mdc | 20 962 | 5 241 | 9.8% |
| workflow-compliance-letter-contragent.mdc | 16 073 | 4 018 | 7.5% |
| workflow-donations.mdc | 12 331 | 3 083 | 5.7% |
| rule-all-stages-execution.mdc | 11 491 | 2 873 | 5.3% |
| rule-memory-bank-usage.mdc | 7 118 | 1 780 | 3.3% |
| rule-single-stage-execution.mdc | 6 825 | 1 706 | 3.2% |
| **ИТОГО** | **214 925** | **53 731** | **100%** |

### Доступный бюджет для работы

| Модель (типичное окно) | Контекст | Фиксированные | Доступно для работы | Примечание |
|------------------------|----------|----------------|---------------------|------------|
| 128K токенов | 128 000 | ~65 000 | **~63 000** | Чтение 3-4 KB-файлов + диалог |
| 200K токенов | 200 000 | ~65 000 | **~135 000** | Комфортный запас |
| 32K токенов | 32 000 | ~65 000 | **⛔ Недостаточно** | Промпт не помещается |

**Зафиксированный инцидент:** Context Condensed 122K → 57K при чтении ~6 файлов из knowledge-base (Шаг 5 развёртывания, модель с 128K окном). Причина: 65K фиксированных + 57K KB-файлов = 122K → сработал condensation.

---

## 3. Жёсткие ограничения платформы

### Tool Use (не переопределяются нашими instructions)

| Ограничение | Формулировка | Архитектурное влияние |
|-------------|-------------|----------------------|
| Один tool call за сообщение | "You must use exactly one tool per message, and every assistant message must include a tool call" | Паузы внутри запроса невозможны → двухшаговый процесс |
| Ожидание подтверждения | "It is critical you wait for the user's response after each tool use" | Каждый tool call = отдельный цикл |
| attempt_completion после подтверждения | "This tool CANNOT be used until you've confirmed from the user that any previous tool uses were successful" | Встроенная защита от преждевременного завершения |
| Запрет на разговорность | "STRICTLY FORBIDDEN from starting messages with Great, Certainly, Okay, Sure" | Синергия с нашим output_style |
| File restrictions по режимам | Architect: `\.md$` only | Architect не может создавать .mdc → переход в Code |
| write_to_file = полный контент | "ALWAYS provide the COMPLETE file content" | Предпочитать apply_diff для больших файлов |
| MCP: точные идентификаторы | "server_name and tool_name are opaque string identifiers. They must be copied exactly" | Важно для MCP-интеграции |

### Mode-specific restrictions

| Режим | Ограничение файлов | Влияние |
|-------|-------------------|---------|
| Architect | Только `\.md$` | Не может создавать .mdc, .txt, код |
| Code | Без ограничений | Основной исполнитель |
| Ask | read-only (не создаёт/не редактирует файлы) | Только анализ и ответы |
| Debug | ? (требует проверки) | — |
| Orchestrator | ? (требует проверки) | Управляет todo list |

### Встроенные инструменты

| Инструмент | Назначение | Наше использование |
|-----------|-----------|-------------------|
| update_todo_list | Чеклист прогресса | Orchestrator: адаптивный трекинг |
| ask_followup_question | Уточнения (с 2-4 suggestions) | Stop conditions в workflows |
| switch_mode | Переключение режимов | Skill chaining (требует подтверждения пользователя) |
| new_task | Создание задачи в другом режиме | Не используем |
| attempt_completion | Завершение задачи | Финализация после верификации |
| fetch_instructions | Инструкции по созданию MCP/Mode | Не используем |

### Доступные инструменты файловой системы

| Инструмент | Назначение | Ограничения |
|-----------|-----------|------------|
| read_file | Чтение (макс. 5 файлов за запрос) | Лимит 5 файлов → planning чтения |
| write_to_file | Создание/перезапись | Требует ПОЛНЫЙ контент файла |
| apply_diff | Точечные правки | Предпочтительнее write_to_file |
| insert_content | Вставка строк | Line 0 = append в конец |
| search_and_replace | Поиск и замена (regex) | Поддерживает batch |
| search_files | Regex-поиск по файлам | Рекурсивный, с контекстом |
| list_files | Список файлов | Рекурсивный или top-level |
| list_code_definition_names | Определения в коде | Для навигации по codebase |

---

## 4. Override System Prompt

**Доступен** через секцию «Дополнительно» в настройках каждого Mode. Создаёт файл `.codeassistant/system-prompt-{mode}`, который **заменяет весь дефолтный системный промпт**.

**Потенциал:** убрать ограничение "один tool call", модифицировать Tool Use, добавить мета-инструкции на уровне платформы.

**Риски:** без секции Tool Use модель теряет способность вызывать инструменты; без System Information — не знает ОС/workspace.

**Текущее решение:** Заморожен. Вернуться только при непреодолимом ограничении.

**Безопасный эксперимент (если потребуется):**
1. Скопировать полный промпт через «Скопировать системный промпт в буфер обмена»
2. Сохранить как `.codeassistant/system-prompt-{mode}`
3. Точечные изменения (не удалять секции)
4. Тестировать на некритичных задачах
5. При проблемах — удалить файл (платформа вернётся к дефолту)

---

## 5. Архитектурные следствия

### Context Budget = главный ограничитель

Каждый новый workflow стоит **5 000–8 500 токенов** контекста для ВСЕХ режимов, ВСЕХ запросов. Это скрытый tax. При 128K-модели добавление 3 новых workflows может привести к регулярному context condensation.

**Импликация для Уровня 1 (Interface Contract):** dependency declaration во frontmatter не решает проблему context budget. Файл всё равно загружается целиком. Нужен другой механизм — например, вынесение тела workflows в отдельные файлы, на которые ссылается .mdc, и которые читаются через read_file только при активации.

**Импликация для Уровня 3 (Context Debt):** основной источник context debt — не memory bank (7K + 7K + 5K + 3K ≈ 22K), а сами workflow-файлы (215K). Compression cycle для lessons-learned полезен, но маргинален по сравнению с оптимизацией workflows.

### Три уровня контроля (уточнение)

| Уровень | Механизм | Работает? | Источник знания |
|---------|----------|-----------|-----------------|
| Содержание (что делать) | Custom instructions, mode instructions | ✅ | Наблюдения 4, 7 |
| Поток (когда остановиться) | Определяется платформой (tool use cycle) | ❌ не контролируем | Наблюдение 4 |
| Рассуждение (порядок мышления) | SGR-структура шаблонов | ✅ | SGR-адаптация v2.4 |
| Видимость (что загружено) | Все .mdc загружаются всегда | ❌ не контролируем | **Новое: анализ промпта** |

### Паттерн «Thin .mdc + Fat read_file»

**Гипотеза:** Можно ли разделить workflow на:
- **Thin .mdc** (в rules/): триггеры, маршрутизация, Шаг 0 — ~2-3 KB
- **Fat body** (в docs/ или memory/): полные инструкции шагов — читаются через read_file только при активации

**Потенциал:** сократить фиксированные затраты с ~54K до ~10-15K токенов.

**Риск:** добавляет 1-2 tool call на чтение body при каждой активации workflow.

**Статус:** Гипотеза. Требует проверки — будет ли модель корректно следовать инструкциям из read_file так же, как из системного промпта.

---

## 6. Открытые вопросы

| # | Вопрос | Как проверить |
|---|--------|---------------|
| 1 | Загружают ли другие режимы (Code, Ask, Debug) те же .mdc файлы? | Экспорт промпта каждого режима |
| 2 | Влияет ли `globs` на загрузку (или только на применение)? | Тест: создать .mdc с globs: '*.py', проверить видимость |
| 3 | Какое окно контекста у каждой модели на платформе? | Проверить документацию моделей |
| 4 | Работает ли паттерн «Thin .mdc + Fat read_file»? | Тест: вынести тело одного workflow, проверить исполнение |
| 5 | Есть ли лимит на количество .mdc файлов? | Проверить при масштабировании |
| 6 | Сжимает ли платформа rules при context overflow? | Проверить, какие секции теряются при condensation |

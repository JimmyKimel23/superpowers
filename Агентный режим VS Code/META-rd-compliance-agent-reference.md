# R&D Памятка: Compliance AI Agent
## Концепции, фреймворки, идеи и открытия

> Подборка всех ключевых идей, обсуждавшихся в проекте. Для каждой — суть, статус применения и выводы.

---

## I. АРХИТЕКТУРНЫЕ КОНЦЕПЦИИ

### 1. Трёхслойная архитектура + Memory Layer

**Суть:** Разделение инструкций по уровню абстракции. Каждый слой независимо масштабируется — новый процесс = новый файл, без переписывания базовых слоёв.

| Слой | Что содержит | Точка конфигурации |
|------|-------------|-------------------|
| Слой 1 — Base Layer | Роль, принципы, язык, стиль, uncertainty protocol, memory protocol | Custom Instructions for All Modes |
| Слой 2 — Mode Extensions | Per-mode инструкции: Role + When to Use + Custom Instructions | Mode-specific settings (5 режимов) |
| Слой 3 — Workflow Templates | .mdc файлы под конкретные процессы (donations, G&H, AKO, ticket recon) | `.codeassistant/rules/` |
| Memory Layer | lessons-learned, definitions, patterns, index.md | `.codeassistant/memory/` |

**Статус:** ✅ Реализовано (v1.0 → v2.5). Работает как задумано — слои не конфликтуют, масштабирование подтверждено (5 workflows добавлены без изменений в слоях 1-2).

---

### 2. Composable Skills / Composable Workflows

**Суть:** Каждый workflow — самостоятельный, переиспользуемый модуль с триггерами, шагами, stop conditions и антипаттернами. Активируется по контексту через триггеры в YAML-заголовке .mdc файла.

**Источник:** Концепция заимствована из **Superpowers** (obra/superpowers, ~41k★, MIT) — фреймворка навыков для AI coding-агентов. Адаптирована с coding-домена (TDD, git, code review) на compliance-домен (источники → анализ → findings).

**Статус:** ✅ Реализовано. Работает — модель находит и применяет workflows по триггерам. Подтверждено тестами: workflow-ticket-recon, workflow-donations, workflow-ako-validation.

---

### 3. Контроль содержания vs контроль потока

**Суть:** Фундаментальное открытие проекта. Custom instructions в агентных платформах контролируют **что** модель делает (содержание), но **не когда** она останавливается (поток). Автономные режимы (Architect, Code, Orchestrator) работают в цикле «plan → execute all → deliver», который не прерывается пользовательскими инструкциями о паузах.

**Три типа контроля:**

| Тип контроля | Механизм | Работает? |
|-------------|---------|-----------|
| Содержание (что делать, в каком формате) | Custom instructions, mode instructions | ✅ Да |
| Поток (когда остановиться, когда спросить) | Разделение на несколько запросов | ✅ Да (обходной путь) |
| Рассуждение (в каком порядке думать) | Структура шаблона (SGR-адаптация) | ✅ Да (промпт-уровень) |

**Контрмера:** Двухшаговый процесс (запрос 1 = план, запрос 2 = создание файла). Валидация между запросами.

**Статус:** ✅ Подтверждено на 3+ моделях (qwen3-vl-235b, Kimi K2, GLM 4.6). Зафиксировано как Наблюдение 4, основа для всех последующих архитектурных решений.

---

### 4. alwaysApply = видимость, не исполнение

**Суть:** Rules с `alwaysApply: true` видны агенту (подтверждено через Ask Mode), но не исполняются автоматически. Агент видит rule, может использовать — но не обязан выполнять. Для обязательного исполнения процедура должна быть встроена как **шаг внутри workflow** (например, Шаг 0).

**Следствие:** Два типа rules по назначению:
- **alwaysApply rule** = справочный контекст (определения, приоритеты, принципы)
- **Шаг внутри workflow** = обязательная процедура (memory bank check, подготовка, верификация)

**Статус:** ✅ Подтверждено экспериментально (Наблюдение 7). Контрмера (Шаг 0 в workflows) протестирована — работает.

---

### 5. Не заменять встроенные инструменты платформы

**Суть:** Orchestrator интегрирован с `update_todo_list` по дефолту. Попытка заменить его кастомным tracking file = борьба с потоком платформы. Решение: использовать встроенный инструмент с расширением (добавить ключевой результат к каждому [X]), а для межзапросных задач — отдельный tracking file.

**Статус:** ✅ Подтверждено (Наблюдение 8). Реализовано в v2.5 как «адаптивный прогресс-трекинг».

---

## II. ВНЕШНИЕ ФРЕЙМВОРКИ И АДАПТАЦИИ

### 6. Superpowers (obra/superpowers)

**Суть:** Open-source фреймворк навыков для AI coding-агентов. Ключевой цикл: Brainstorming → Planning → Execution (subagent-driven) → TDD → Code Review → Finish.

**Что заимствовано (14 практик):**

| # | Практика | Статус | Где реализовано |
|---|---------|--------|----------------|
| 1 | Mandatory Enforcement — обязательное следование workflow | ✅ | Orchestrator |
| 2 | Two-Stage Review — двухэтапная верификация | ✅ | Debug Mode |
| 3 | Verification Before Completion — верификация перед закрытием | ✅ | Каждый workflow + Слой 1 |
| 4 | Skill Chaining — явные переходы между режимами | ✅ | Все Mode instructions |
| 5 | Anti-Rationalization — противодействие обходам инструкций | ✅ | patterns.md + Слой 1 |
| 6 | Incremental Validation → Two-Step Process | ✅ | Architect (v2.3) |
| 7 | Progress Tracking — обязательный чеклист | ✅ | Orchestrator |
| 8 | Stop Conditions + Anti-patterns в каждом workflow | ✅ | Все workflows |
| 9 | SGR-адаптация (см. п.7 ниже) | ✅ | v2.4, v2.5 |
| 10 | Memory Bank Navigation | ✅ | index.md, rule-memory-bank-usage |
| 11 | Stage Execution Cycle (пятифазный цикл) | ✅ | Code Mode (v2.5) |
| 12 | Progress Tracking File | ✅ | Orchestrator (v2.5, адаптивный) |
| 13 | Context Reset | ✅ | Orchestrator (v2.5) |
| 14 | Information Priority (иерархия источников) | ✅ | Слой 1, принцип 9 (v2.5) |

**Что не заимствовано:** TDD-цикл (не применим к compliance), subagent-driven development (платформа не поддерживает вложенных агентов), Git worktrees.

---

### 7. Schema-Guided Reasoning (SGR)

**Источник:** abdullin.com/schema-guided-reasoning/, vamplabAI/sgr-agent-core (~915★, MIT).

**Суть:** Методология управления рассуждением LLM через **структуру вывода**. Ключевая идея: порядок полей в шаблоне определяет порядок мышления модели. Если модель сначала заполняет «данные», потом «сопоставление», потом «red flags» — она вынуждена пройти аналитический путь до того, как сформулирует выводы.

**Полный SGR vs промпт-адаптация:**

| Аспект | Полный SGR | Промпт-адаптация (наш подход) |
|--------|-----------|------------------------------|
| Требования | Python + Structured Outputs API + constrained decoding | Только промпты |
| Гарантия заполнения | Физическая — модель не может пропустить поле | Организационная — модель может проскочить |
| Уровень компетенций | Developer-level | No-code |
| Контрмера при нарушении | Не нужна — невозможно нарушить | Фиксация как рационализация + усиление формулировки |

**Адаптированные SGR-принципы:**

| Принцип | Адаптация | Где |
|---------|-----------|-----|
| Порядок полей = порядок мышления | Рабочие секции (данные → сопоставление → red flags) ДО findings | Code Mode (шаблон findings), Слой 1 (принцип 8) |
| Current state перед действием | «Текущее состояние» + «Итог шага» в каждом шаге workflow | Все workflows, Architect (SGR-структура шагов) |
| Plan many, execute one | Переоценка состояния после каждого шага | Orchestrator (п.6) |
| Встроенная верификация | «Проверка основания» и «Обоснование градации» внутри каждого finding | Code Mode, Debug (SGR-проверка) |

**Статус:** ✅ Адаптировано в v2.4. Паттерн SGR-структуры шага стал обязательным для всех новых workflows. Промпт-адаптация не даёт физической гарантии — мониторить, заполняются ли рабочие секции.

**Решение о полном SGR:** Отложено. Потребуется при переходе к кастомному решению на уровне кода. В текущей no-code архитектуре промпт-адаптация достаточна.

---

### 8. Prompt Architect (3C Framework)

**Суть:** Фреймворк для генерации промптов: **Contract** (что создаём) → **Context** (платформа, ограничения) → **Constraints** (формат, качество). Использовался при первоначальном проектировании архитектуры.

**Статус:** ✅ Применён однократно (v1.0). Дальнейшие итерации основывались на результатах тестирования, а не на повторном прохождении 3C.

---

### 9. Адаптация внешних Rules (Yandex Code Assistant экосистема)

**Суть:** Три набора Rules из экосистемы Yandex Code Assistant (ориентированные на Go-разработку) адаптированы под compliance-домен:

| Исходный набор | Адаптированный файл | Назначение |
|---|---|---|
| Guidelines for memory bank in microservices | rule-memory-bank-usage.mdc | Порядок работы с memory bank, приоритет источников |
| Rules for single plan stage | rule-single-stage-execution.mdc | Пятифазный цикл выполнения этапа |
| Rules for all plan stages with tracking | rule-all-stages-execution.mdc | Последовательное выполнение с tracking-файлом |

**Ключевые адаптации:** Go-специфика → комплаенс-домен; добавлен блок приоритета источников; добавлена процедура разрешения конфликтов; tracking-файл дополнен строкой состояния (SGR).

**Эволюция:** В v2.5 критические процедуры из rules перенесены в mode instructions (Code Mode, Orchestrator) — на основании Наблюдений 4, 7, 8. Rules остались как справочный контекст.

**Статус:** ✅ Адаптировано. Тип A (rules) → реализован. Тип B (принципы для слоёв 1-2) → частично реализован в v2.5.

---

## III. АРХИТЕКТУРНЫЕ ПАТТЕРНЫ

### 10. Двухшаговый процесс (Two-Step Process)

**Суть:** Замена инкрементальной валидации (не работает в автономных режимах) на разделение запросов. Запрос 1 = покажи план, НЕ создавай файлы. Запрос 2 = создай файл после подтверждения. Валидация происходит между запросами.

**Применимость:** Все автономные режимы (Architect, Code, Orchestrator). Ключевая контрмера для ограничения «контроль потока невозможен».

**Статус:** ✅ Реализовано в Architect (v2.3). Работает.

---

### 11. Двухэтапная верификация (Two-Stage Review)

**Суть:** Debug Mode разделяет проверку на два последовательных этапа:
1. **Spec Compliance** — сделано ли именно то, что просили (scope, источники, полнота)
2. **Quality Review** — качество выводов (обоснованность, ссылки, градация рисков)

Этап 2 запускается только после прохождения Этапа 1. Это закрывает типичный failure mode: результат хорошо оформлен, но не соответствует заданию.

**Источник:** Superpowers (spec compliance review + code quality review).

**Статус:** ✅ Реализовано в Debug Mode.

---

### 12. Skill Chaining (явные переходы между режимами)

**Суть:** В конце работы каждого режима — явное предложение перехода в следующий. Architect → «Переключиться в Code Mode?». Code → «Переключиться в Debug Mode?». Debug → «Вернуть в Code Mode для исправлений» или «Обновить memory».

**Статус:** ✅ Реализовано. Работает непоследовательно — модели иногда пропускают предложение перехода (зафиксировано как рационализация).

---

### 13. Шаг 0 — обязательная подготовка в workflow

**Суть:** Явный шаг перед основной работой: чтение index.md → проверка lessons-learned → проверка patterns → идентификация входных документов. Антипаттерн: «НЕ ЧИТАЙ файлы из knowledge-base/, если они не указаны пользователем.»

**Почему нужен:** Без Шага 0 агент заполняет «подготовку» произвольным чтением нерелевантных файлов (Наблюдение — Code Mode, qwen3-vl-235b). Шаг 0 даёт явный список, что читать первым.

**Статус:** ✅ Реализовано в 5 workflows. Протестировано — работает (GLM 4.6, Architect Mode).

---

### 14. Пятифазный цикл исполнения (Stage Execution Cycle)

**Суть:** Структурированный цикл для Code Mode:
1. **Analysis** — понять задачу, определить scope
2. **Preparation** — прочитать memory bank, входные документы (= Шаг 0 в workflow-контексте)
3. **Execution** — выполнить основную работу
4. **Verification** — проверить результат (self-check)
5. **Finalization** — оформить, предложить переход в Debug

**Источник:** Адаптация rule-single-stage-execution из экосистемы Yandex Code Assistant.

**Статус:** ✅ Подготовлено в v2.5. Ожидает тестирования.

---

### 15. Адаптивный прогресс-трекинг

**Суть:** Два режима в зависимости от длительности задачи:
- **Внутри одного запроса:** `update_todo_list` платформы. Каждый [X] с ключевым результатом.
- **Межзапросные задачи:** tracking file в `workflows/active/`. Первое действие нового запроса = чтение tracking file.

**Почему не единый формат:** Orchestrator интегрирован с todo list по дефолту — попытка заменить на свой = борьба с платформой (Наблюдение 8).

**Статус:** ✅ Подготовлено в v2.5. Ожидает тестирования.

---

### 16. Иерархия источников (Information Priority)

**Суть:** Явный приоритет при конфликтах:
1. Внутренние политики компании
2. Memory bank (lessons-learned, patterns, definitions)
3. Документы конкретной задачи
4. Внешняя регуляция
5. Общие знания модели

Процедура разрешения конфликтов между одноуровневыми источниками: зафиксировать обе позиции, обозначить расхождение, обратиться к пользователю.

**Статус:** ✅ Реализовано как принцип 9 в Слое 1 (v2.5). Ожидает тестирования на реальных конфликтах.

---

### 17. Anti-Rationalization (противодействие обходам инструкций)

**Суть:** Модели систематически обходят инструкции, при этом «рационализируют» обход. Типичные паттерны: «задача простая, workflow не нужен», «я уже знаю, как это делать», «пользователь не просил об этом». Контрмера: явная блокировка каждой рационализации в промпте + фиксация в patterns.md с указанием модели.

**Зафиксированные рационализации:**
- Создание .md вместо .mdc (все модели)
- Пропуск skill chaining (все модели)
- Чтение нерелевантных файлов вместо указанных (qwen3-vl-235b)
- Игнорирование инкрементальной валидации (все модели → переквалифицировано в ограничение платформы)

**Ключевой инсайт:** Разные модели рационализируют по-разному. Фиксация с указанием модели позволяет формулировать точечные контрмеры.

**Статус:** ✅ Реализовано как непрерывный процесс.

---

## IV. WORKFLOWS (РЕАЛИЗОВАННЫЕ)

### 18. workflow-donations — проверка благотворительных пожертвований

**Суть:** 7 шагов (+ Шаг 0): извлечение параметров согласования → соглашения → отчётов → cross-reference → red flags → генерация выводов → верификация. Первый workflow, создан в v1.0, обновлён в v2.4 (SGR-структура шагов) и v2.5 (Шаг 0).

**Статус:** ✅ Работает. Успешно протестирован на реальном сценарии ($50,000 фонд в Узбекистане).

---

### 19. workflow-gifts-hospitality — проверка подарков и гостеприимства

**Суть:** Проверка G&H запросов с учётом порогов (11 000 ₽, 3 000 ₽ для ГДЛ), юрисдикционных особенностей (запрет в Казахстане), специфики компании (колонки с Алисой, товары СТМ). Спроектирован Architect Mode в ходе тестирования Фазы 2.

**Статус:** ✅ Создан. Требует переименования в .mdc и добавления ссылок на пункты политик.

---

### 20. workflow-ako-validation — валидация антикоррупционных оговорок

**Суть:** Многоэтапный workflow для анализа АКО контрагентов: scope check → intake → confirmation gate → декомпозиция полных АКО → маршрутизация по сценариям S0-S9 → формат ответа → self-check. Включает анализ корпоративных документов (кодексы, политики), опросников, и режим redline.

**Статус:** ✅ Создан. Интегрирован с knowledge-base (шаблоны АКО, сценарии, примеры).

---

### 21. workflow-doc-coauthoring — совместное написание документов

**Суть:** Структурированный workflow для co-authoring документации через AI. Интегрирует SGR-структуру, двухэтапную верификацию, skill chaining между режимами.

**Статус:** ✅ Создан и протестирован.

---

### 22. workflow-ticket-recon — разведка тикета (Яндекс Трекер)

**Суть:** Сбор и структурирование информации из тикетов через MCP (Model Context Protocol). Шаги: GetIssue (основной) → GetIssueLinks → GetIssue (связанные, облегчённый) → формирование сводки. Интегрирован с MCP Яндекс Трекер.

**Особенности:** Связанные тикеты запрашиваются без `description` (защита от context overflow). GetAttachmentContent отключён на уровне платформы + запрет в инструкции (двухуровневая защита).

**Статус:** ✅ Создан и протестирован (Kimi K2 Thinking, 3 формулировки). Триггеры работают надёжно. Скорректирован по итогам теста.

---

## V. ПЛАТФОРМЕННЫЕ ОТКРЫТИЯ

### 23. Реверс-инжиниринг дефолтного промпта

**Суть:** В настройках каждого Mode есть «Скопировать системный промпт» — даёт полный финальный промпт, который получает модель. Обнаружена 5-секционная структура: Role Definition → Markdown Rules → Tool Use → System Information → User's Custom Instructions. Наши инструкции попадают в последнюю секцию.

**Ключевые ограничения платформы (из Tool Use, не переопределяются):**
- Один tool call за сообщение
- Ожидание подтверждения после каждого tool call
- attempt_completion только после подтверждения
- Запрет на разговорность

---

### 24. Совместимость custom instructions с дефолтами

**Точки синергии:** Стиль общения (оба анти-«Great/Certainly»), Ask Mode (оба запрещают изменение файлов), Code Mode (оба пошаговые).

**Точки с мостами (решено):**
- Architect: todo list (дефолт) + двухшаговый процесс (наш)
- Debug: code debugging (дефолт) vs compliance QA (наш) — разграничение в преамбуле

---

### 25. Context overflow при глубоком поиске

**Проблема:** При комплексных запросах агент читает слишком много файлов → упирается в лимит контекста (121k → 57k при condensing). Часть информации может теряться при сжатии.

**Контрмеры:** Ограничение глубины поиска, оптимизация структуры knowledge-base, Шаг 0 (не читать всё подряд), облегчённый запрос для связанных тикетов (без description).

**Статус:** ⚠️ Открытый риск. SGR-секции + пятифазный цикл увеличивают объём — мониторить.

---

## VI. НЕРЕАЛИЗОВАННЫЕ / ОТЛОЖЕННЫЕ ИДЕИ

### 26. Полный SGR с constrained decoding

**Суть:** Python + JSON Schema + Structured Outputs API — физически не даёт модели сгенерировать ответ вне схемы.

**Почему отложено:** Требует developer-level компетенций, выходит за рамки no-code подхода. Был бы уместен только для полностью кастомного решения.

**Когда вернуться:** При переходе от платформенного решения (Yandex Code Assistant) к кастомному (собственный backend + API).

---

### 27. Subagent-driven execution

**Суть:** Декомпозиция compliance-проверки на подзадачи, каждая выполняется отдельным агентом с собственным ревью. Идея из Superpowers.

**Почему не реализовано:** Платформа не поддерживает вложенных агентов. Orchestrator делегирует режимам, но не создаёт параллельных подагентов.

**Когда вернуться:** При появлении поддержки multi-agent в платформе или при переходе на Claude Code / Codex.

---

### 28. Кастомные режимы (custom_modes.yaml)

**Суть:** Создание собственных режимов вместо настройки существующих 5.

**Почему не реализовано:** Принято решение сохранить стандартную модель режимов (Architect / Code / Ask / Debug / Orchestrator) и персонализировать через custom instructions. Стандартные режимы покрывают все нужные сценарии, а customization через инструкции проще в поддержке.

---

### 29. Инкрементальная валидация внутри одного запроса

**Суть:** Показывать план по секциям, после каждой спрашивать подтверждение пользователя.

**Почему не работает:** Автономные режимы платформы реализуют цикл «plan → execute all → deliver», который не прерывается custom instructions. Протестировано на 3+ моделях. Усиление формулировок (КРИТИЧЕСКОЕ ПРАВИЛО, «начни заново») не помогает.

**Заменено на:** Двухшаговый процесс (п.10).

---

## VII. КЛЮЧЕВЫЕ ПРИНЦИПЫ (Base Layer, Слой 1)

Девять принципов, накопленных за весь проект:

1. **Точность превыше скорости** — не выдумывать, указывать «данные отсутствуют»
2. **Работа с источниками** — каждый вывод привязан к конкретному документу/пункту
3. **Структура выводов** — наблюдение → основание → рекомендация (actionable)
4. **Комплаенс-специфика** — градация рисков, red flags, варианты в grey area
5. **Конфиденциальность** — данные конфиденциальны по умолчанию
6. **Верификация перед завершением** — перечитать задание, пройти чеклист
7. **Контрмеры рационализаций** — фиксировать обходы, встраивать блокировки
8. **Структура определяет рассуждение (SGR)** — порядок секций = порядок мышления
9. **Приоритет источников** — внутренние политики > memory bank > документы задачи > регуляция > знания модели

---

## VIII. ХРОНОЛОГИЯ ВЕРСИЙ

| Версия | Дата | Ключевое изменение |
|--------|------|-------------------|
| v1.0 | 2026-02-18 | Исходная трёхслойная архитектура + Memory Layer |
| v2.0 | 2026-02-18 | Интеграция 8 best practices из Superpowers |
| v2.1 | 2026-02-19 | Совместимость с дефолтами платформы, мосты Architect/Debug |
| v2.2 | 2026-02-21 | Попытка усилить инкрементальную валидацию (не сработала) |
| v2.3 | 2026-02-21 | Двухшаговый процесс вместо инкрементальной валидации |
| v2.4 | 2026-02-22 | SGR-адаптация: 4 принципа в промптах |
| v2.5 | 2026-02-23 | Enforcement через mode instructions: пятифазный цикл, адаптивный трекинг, принцип 9 |

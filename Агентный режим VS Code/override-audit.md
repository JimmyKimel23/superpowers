# Аудит: Override System Prompt — потенциал сжатия

## Что заменяет Override

Override заменяет **дефолтный системный промпт** — всё, что платформа генерирует автоматически.
Он НЕ заменяет: Rules (.mdc) и Custom Instructions (наш Layer 1 + Layer 2).

Из вставленного промпта (Ask Mode) — Override-replaceable секции:

---

## Секция 1: Role line
**Содержание:** "Compliance Advisor — AI-ассистент по вопросам ABC-комплаенс..."
**~100 токенов**
**Потенциал сжатия:** 0 — и так минимальна.

---

## Секция 2: MARKDOWN RULES  
**Содержание:** Правило clickable ссылок для language constructs и filename references.
**~80 токенов**
**Потенциал сжатия:** Низкий. Специфично для Code/Architect, в Ask Mode может быть удалено.
**Экономия:** ~80 токенов (если удалить для Ask)

---

## Секция 3: TOOL USE — определения инструментов
**Содержание:** Полные описания, параметры, примеры для каждого tool.

| Tool | Оценка токенов | Используем? | Действие |
|------|---------------|-------------|----------|
| read_file | ~500 | ✅ Да (memory, KB) | Сократить примеры |
| fetch_instructions | ~150 | ❌ Редко | Убрать примеры |
| search_files | ~300 | ✅ Да | Оставить, сократить |
| list_files | ~200 | ✅ Да | Оставить, сократить |
| list_code_definition_names | ~250 | ❌ Нет (не код) | **Убрать полностью** |
| use_mcp_tool | ~250 | ✅ Да (tracker) | Оставить, сократить |
| access_mcp_resource | ~200 | ❌ Нет | **Убрать полностью** |
| ask_followup_question | ~300 | ✅ Да | Сократить примеры |
| attempt_completion | ~300 | ✅ Да | Сократить |
| switch_mode | ~200 | ✅ Да | Оставить |
| new_task | ~200 | ⚠️ Редко | Сократить |
| update_todo_list | ~1000 | ✅ Да | Сократить verbose описание |

**Подитог Tool definitions: ~3 850 токенов**
**Потенциал сжатия: ~1 200 токенов** (убрать list_code_definition_names, access_mcp_resource; сократить примеры и verbose описания)

---

## Секция 4: TOOL USE GUIDELINES
**Содержание:** 6 пунктов общих правил + детальные пояснения по каждому.
**~700 токенов**
**Потенциал сжатия: ~300 токенов** — многие правила повторяют друг друга (wait for confirmation упомянуто 3 раза).

---

## Секция 5: MCP SERVERS — tracker_mcp ⬅️ ГЛАВНАЯ ЦЕЛЬ

**Содержание:** Полные JSON Schema и описания для КАЖДОГО MCP-метода.

### 5a. Методы, которые мы АКТИВНО используем:

| Метод | Оценка токенов | Примечание |
|-------|---------------|------------|
| GetIssue | ~700 | Нужен полностью |
| GetIssueLinks | ~200 | Нужен полностью |
| GetIssues | **~2 500** | Содержит ПОЛНУЮ документацию Yandex Tracker Query Language! |
| GetAttachment | ~150 | Нужен (метаданные) |
| GetIssueChangeLog | **~1 800** | Огромное описание с полным списком типов |

**Подитог активные: ~5 350 токенов**

### 5b. Методы, которые мы НЕ используем или ЗАПРЕЩЕНЫ:

| Метод | Оценка токенов | Статус | Действие |
|-------|---------------|--------|----------|
| GetProject | ~150 | Не используем | **Убрать** |
| GetPortfolio | ~150 | Не используем | **Убрать** |
| GetGoal | ~150 | Не используем | **Убрать** |
| SearchEntities | ~700 | Не используем | **Убрать** |
| GetAttachmentContent | ~200 | **ЗАПРЕЩЁН** | **Убрать** |
| CreateGoal | ~700 | Не используем | **Убрать** |
| UpdateGoal | ~500 | Не используем | **Убрать** |
| DeleteGoal | ~150 | Не используем | **Убрать** |
| CreateIssue | ~500 | Не в read-only WF | ⚠️ Оставить? |
| CreateComment | ~200 | Не в read-only WF | ⚠️ Оставить? |
| CreateProjectComment | ~150 | Не используем | **Убрать** |
| CreatePortfolioComment | ~150 | Не используем | **Убрать** |
| CreateGoalComment | ~150 | Не используем | **Убрать** |
| ChangeIssueStatus | ~300 | Не в read-only WF | ⚠️ Оставить? |
| UpdateIssue | ~500 | Не в read-only WF | ⚠️ Оставить? |
| BulkUpdate | ~500 | Не используем | **Убрать** |
| BulkTransition | ~500 | Не используем | **Убрать** |
| BulkMove | ~700 | Не используем | **Убрать** |
| WaitForBulkChange | ~150 | Не используем | **Убрать** |
| BulkUpdateMetaEntities | ~700 | Не используем | **Убрать** |

**Подитог НЕиспользуемые: ~6 250 токенов**

### 5c. Потенциал сжатия активных методов:

**GetIssues (~2 500 → ~800):** Полная документация Query Language избыточна. 
Достаточно: синтаксис базовых фильтров + 3 примера. Экономия: ~1 700 токенов.

**GetIssueChangeLog (~1 800 → ~600):** Полный список типов изменений с русскими переводами.
Достаточно: основные типы + ссылка "остальные см. документацию". Экономия: ~1 200 токенов.

**Подитог сжатие активных: ~2 900 токенов**

### ИТОГО по MCP:
- Убрать неиспользуемые: **~6 250 токенов**
- Сжать активные: **~2 900 токенов**  
- **Суммарная экономия MCP: ~9 150 токенов**

---

## Секция 6: CAPABILITIES
**Содержание:** Описание возможностей агента (CLI, файлы, search, MCP).
**~700 токенов**
**Потенциал сжатия: ~300 токенов** — verbose описания того, что агент и так умеет.

---

## Секция 7: MODES
**Содержание:** Список режимов с описаниями.
**~400 токенов**
**Потенциал сжатия: ~100 токенов** — наши описания, лучше не трогать.

---

## Секция 8: RULES header
**Содержание:** Техническое введение к секции Rules.
**~100 токенов**
**Примечание:** Rules (.mdc) добавляются платформой ПОВЕРХ override — эту секцию override не контролирует.

---

## Секция 9: SYSTEM INFORMATION
**Содержание:** OS, shell, home directory, workspace.
**~300 токенов**
**Потенциал сжатия:** 0 — критично для работы инструментов.

---

## Секция 10: OBJECTIVE
**Содержание:** 5-step process + verbose описание подхода.
**~500 токенов**  
**Потенциал сжатия: ~200 токенов** — можно сжать без потери смысла.

---

## Секция 11: USER'S CUSTOM INSTRUCTIONS header
**Содержание:** Language preference line + заголовок.
**~50 токенов**
**Примечание:** Наш Layer 1/Layer 2 идёт отдельно, не в override.

---

# СВОДКА

## Текущий объём Override-replaceable контента (оценка)

| Секция | Токены | Можно сэкономить |
|--------|--------|-------------------|
| Role line | 100 | 0 |
| Markdown Rules | 80 | 80 |
| Tool definitions | 3 850 | 1 200 |
| Tool Use Guidelines | 700 | 300 |
| **MCP Servers** | **11 600** | **9 150** |
| Capabilities | 700 | 300 |
| Modes | 400 | 100 |
| System Information | 300 | 0 |
| Objective | 500 | 200 |
| Прочее | 150 | 0 |
| **ИТОГО** | **~18 400** | **~11 330** |

## Ключевые числа

- **Текущий объём Части 1:** ~18 400 токенов
- **После lean override:** ~7 100 токенов
- **Экономия: ~11 300 токенов (61%)**

## Где основная экономия

```
MCP неиспользуемые методы:   6 250 токенов (55% экономии)
MCP сжатие активных:         2 900 токенов (26%)
Tool definitions cleanup:    1 200 токенов (11%)
Прочие секции:                 980 токенов (8%)
```

**Вывод: 81% экономии — из секции MCP.** 
Убрать описания Goals, Portfolios, Projects, Bulk-операций, GetAttachmentContent — это не потеря функциональности, а удаление мёртвого кода из промпта.

## Риски

| Риск | Вероятность | Mitigation |
|------|-------------|------------|
| Модель теряет tool calling | Средняя | Сохранить секцию Tool Use с описаниями используемых tools |
| Модель не знает MCP-параметры | Низкая | Оставить полные schema для GetIssue, GetIssueLinks, GetIssues |
| Другая модель требует verbose | Средняя | Тестировать на GLM + Qwen; rollback = удалить файл override |
| Неиспользуемый метод понадобился | Низкая | Добавить обратно в override при необходимости |

## План эксперимента (если решим делать)

1. Скопировать текущий полный промпт (кнопка "Скопировать в буфер")
2. Создать lean-версию: убрать неиспользуемые MCP, сократить verbose
3. Сохранить как `.codeassistant/system-prompt-ask`
4. Прогнать 3 теста: простой вопрос, ticket-recon, G&H анализ
5. Сравнить качество с baseline
6. Если OK → повторить для других modes
7. Если проблемы → удалить файл (instant rollback)
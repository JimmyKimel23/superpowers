# Рабочие паттерны — Compliance AI Assistant

## Формат записи
<!-- Название паттерна | Когда применять | Описание -->

## Паттерны

### Антипаттерн: Thin stub + read_file для workflow body
- **Когда НЕ применять:** Никогда. Попытка вынести тело workflow из .mdc в отдельный файл с инструкцией read_file в stub.
- **Почему не работает:** read_file в .mdc = flow control. Модели (GLM 4.6, Qwen 3 VL 235B) игнорируют инструкцию и импровизируют. Протестировано в двух вариантах (с кратким содержанием и без) — оба провал.
- **Вместо этого:** Workflow body остаётся в .mdc. Для context debt — hot/cold разделение memory bank, compression cycles, lean-версии workflows.
- **Проверено на:** workflow-ticket-recon, TAXIASSIST-593107 (2026-02-26)
- **Связь:** Наблюдения 4, 7, 8; принцип «содержание → .mdc, поток → платформа»

---

### Паттерн: No workflow without RED phase (WDL)
- **Когда:** Создание любого нового workflow через WDL-цикл
- **Как:** Перед написанием .mdc обязательно прогнать 3+ сценария (Lightweight) или 5+ (Full) через Orchestrator БЕЗ workflow. Зафиксировать: какой режим выбран, какие шаги пропущены, какие данные додуманы
- **Почему:** Workflow должен адресовать конкретные провалы, а не гипотетические проблемы. Без baseline — workflow решает несуществующие задачи
- **Исключение:** Bootstrapping — для meta-workflow (workflow-development.mdc) RED невозможна, т.к. workflow ещё не существует. Документируется как accepted risk
- **Источник:** Superpowers writing-skills: «No skill without failing test first»
- **Проверено на:** Пока только концептуально. Ожидается верификация при первом полном WDL-цикле (Фаза D)

---

### Паттерн: RESEARCH before DESIGN (WDL)
- **Когда:** Проектирование любого workflow
- **Как:** До входа в Architect Mode определить: scope (4 вопроса), KB-зависимости, scenario bank (min 3 сценария). Только после этого — двухшаговый процесс в Architect
- **Почему:** Без scope workflow проектируется «из головы» → пропускаются edge cases, триггеры пишутся интуитивно, KB-зависимости не учтены (Наблюдение 9 — G&H workflow без таблицы маршрутизации)
- **Связь:** Anthropic skill-creator: «Understand what the skill should do BEFORE writing it»

---

### Паттерн: Bootstrapping exception для meta-инструментов
- **Когда:** Создание инструмента, который должен применяться к самому себе (meta-workflow, meta-checklist, meta-template)
- **Как:** v1.0 создаётся «вручную» по текущему процессу. Затем ретроспективный bootstrapping test: прогон deployment checklist → gap analysis → закрытие дыр. RED/GREEN = accepted risk
- **Почему:** Bootstrapping paradox — невозможно применить процесс до его создания. Ретроспективная проверка покрывает ~80% value полного цикла
- **Проверено на:** workflow-development.mdc (A4 bootstrapping test)

---

### Паттерн: Таблица маршрутизации в аналитических workflow
- **Когда:** Workflow содержит 3+ этапов и предполагает создание выходного файла
- **Как:** Добавить таблицу «Этап → Режим → Что происходит» + skill chaining инструкции в конце каждого блока режимов
- **Почему:** Без таблицы Orchestrator использует дефолтную маршрутизацию (п.2), которая может направить в неверный режим. Аналитические workflow с выходным файлом = Code Mode, не Ask.
- **Проверено на:** workflow-doc-coauthoring (работает), workflow-gifts-hospitality (до фикса — Ask вместо Code; после фикса — Code → Debug корректно)
- **Применить к:** workflow-donations, workflow-ako-validation (проверить наличие таблицы маршрутизации)

---

### Паттерн: Приоритет workflow над дефолтной маршрутизацией Orchestrator
- **Когда:** Orchestrator получает задачу, для которой существует workflow
- **Как:** П.1 Orchestrator: сначала проверь наличие workflow → если есть, используй маршрутизацию ИЗ workflow. П.2 (дефолтная последовательность) = fallback для задач без workflow.
- **Почему:** Без приоритета Orchestrator классифицирует задачу по п.2 и может направить в неверный режим (G&H-запрос → «вопрос/консультация» → Ask). С приоритетом workflow перехватывает маршрутизацию до классификации.
- **Проверено на:** workflow-gifts-hospitality (GLM, Orchestrator → Code → Debug — корректно)

---

### Паттерн: SGR-структура шага в workflow
- **Когда:** При проектировании любого нового workflow в Architect Mode
- **Как:** Каждый шаг workflow оформляется по структуре:
  ```
  ### Шаг N: [название]
  → Текущее состояние: [что уже есть, чего не хватает — 1-2 предложения]
  
  [Инструкции по выполнению]
  
  → Итог шага: [что получено, какие отклонения]
  ```
- **Зачем:** Модель описывает состояние до действия и фиксирует результат после. Это снижает «инерцию» (проскакивание шагов) и создаёт трейс для верификации.
- **Основано на:** SGR NextStep pattern (abdullin.com/schema-guided-reasoning/)

---

### Паттерн: Шаг 0 — обязательная подготовка в workflow
- **Когда:** Любой workflow, где агент должен проверить memory bank и входные документы до начала работы.
- **Как:**
  1. Добавить Шаг 0 перед существующим Шагом 1
  2. Шаг 0 содержит: чтение index.md → проверка lessons-learned → проверка patterns → идентификация входных документов → антипаттерн (не читать всё подряд из knowledge-base)
  3. Шаг 0 завершается строкой итога: "Memory bank проверен, входные документы идентифицированы"
- **Почему работает:** Агент надёжно следует пошаговой структуре workflow (todo list). Отдельный rule с alwaysApply видим, но не исполняется (Наблюдение 7).
- **Проверено на:** workflow-donations (Тест 2: Architect Mode, GLM 4.6 — сработал).
- **Применено в:** workflow-donations, workflow-gifts-hospitality, workflow-ako-validation, workflow-doc-coauthoring, workflow-ticket-recon.

---

### Паттерн: Разделение rules по назначению (visibility vs enforcement)
- **Когда:** При проектировании новых rules и workflows.
- **Принцип:**
  - **alwaysApply rule** = справочный контекст. Агент видит, может использовать, но НЕ обязан выполнить. Подходит для: определений, приоритетов источников, общих принципов работы с memory bank.
  - **Шаг внутри workflow** = обязательная процедура. Агент выполняет как часть пошагового плана. Подходит для: memory bank check, подготовка, верификация.
- **Связь с:** Наблюдение 4 (custom instructions не контролируют поток), Наблюдение 7 (alwaysApply = видимость, не исполнение).

---

### Паттерн: Адаптивный прогресс-трекинг (v2.5)
- **Когда:** Многоэтапная задача в Orchestrator (3+ шагов)
- **Как:**
  - Внутри одного запроса → `update_todo_list` платформы. Каждый [X] сопровождается ключевым результатом:
    `[X] Шаг 2: Анализ соглашения — 6 параметров, ABC-оговорка отсутствует`
  - Межзапросные задачи → tracking file `[задача]-track.md` в `workflows/active/`. Первое действие нового запроса = чтение tracking file.
  - Не создавай tracking file для задач, выполняемых в одном запросе.
- **Почему:** Orchestrator интегрирован с `update_todo_list` по дефолту. Попытка заменить на кастомный формат = борьба с потоком платформы (см. Наблюдение 8).
- **Проверено на:** Orchestrator Mode, множественные тесты (Наблюдение 8)

---

### Паттерн: Работать С платформой, не против (обобщение Наблюдений 4, 7, 8)
- **Когда:** Проектирование любой кастомной инструкции для Yandex Code Assistant
- **Принцип:** Три уровня контроля:
  1. **Содержание** (что агент делает) → контролируется через custom instructions / mode instructions ✅
  2. **Поток** (когда остановиться, какой инструмент использовать) → определяется платформой, не промптом ❌
  3. **Рассуждение** (в каком порядке думать) → контролируется через структуру шаблона (SGR) ✅
- **Практика:**
  - Если платформа предлагает встроенный инструмент → используй его, расширяй содержание
  - Если нужна пауза → разбей на два запроса пользователя
  - Если нужен определённый порядок рассуждения → задай через обязательные секции шаблона
  - Никогда не пытайся заменить встроенный инструмент кастомным через промпт
- **Проверено на:** Architect (Наблюдение 4), Rules (Наблюдение 7), Orchestrator (Наблюдение 8)

---

### Паттерн: WDL-цикл гарантирует качество workflow
- **Когда:** Создание любого нового workflow для Compliance AI Assistant
- **Как:** Применять полный WDL-цикл (Фазы 0-6): RESEARCH → DESIGN → RED → GREEN → REFACTOR → DEPLOY
- **Почему:** Формализованный процесс гарантирует, что workflow:
  1. Адресует реальные потребности (через RED baseline-тестирование)
  2. Имеет чёткую структуру (SGR-шаги, таблица маршрутизации)
  3. Устойчив к рационализациям (через REFACTOR pressure testing)
  4. Полностью интегрирован в систему (memory layer update)
- **Проверено на:** workflow-sponsorship.mdc (первый полный WDL-цикл)
- **Применимость:** Все будущие workflow

---

### Паттерн: WDL-цикл для адаптации существующих workflow
- **Когда:** Необходимость обновления существующего workflow к новым требованиям или источникам данных
- **Как:** Применять полный WDL-цикл (Фазы 0-6) даже для адаптации, а не только для создания новых workflow
- **Почему:** Гарантирует, что обновления адресуют реальные пробелы, а не гипотетические улучшения
- **Проверено на:** workflow-gifts-hospitality.mdc v2.0 (адаптация к System_instruction.md)
- **Применимость:** Все будущие обновления workflow должны проходить через WDL-цикл

---

### Паттерн: Верификация KB-зависимостей через list_files (NEW)
- **Когда:** Workflow ссылается на внешние KB-файлы (templates, scope rules, policies)
- **Как:** Добавить Шаг 0.5 перед основной логикой:
  1. Выполнить `list_files` для директории `knowledge-base/processes/[workflow-specific-dir]/`
  2. Проверить наличие всех файлов, указанных в workflow
  3. Если файл отсутствует → STOP и сообщить пользователю
  4. Если файл присутствует → продолжить к Шагу 1
- **Почему:** Предотвращает blind spots и ложные выводы об отсутствии критических файлов. Разрешает парадокс между Hard Constraint #7 (KB First) и инструкцией "НЕ ЧИТАЙ файлы из knowledge-base".
- **Проверено на:** Анализ workflow-ako-validation.mdc (2026-02-25) — выявило ложный вывод об отсутствии `АКО_templates_yandex_yango.md` и `references-scope-rules v.2.md`
- **Применимость:** Все workflow с внешними KB-зависимостями (ako-validation, donations, sponsorship, gifts-hospitality)

---

### Паттерн: Различие между чтением содержимого и проверкой наличия (NEW)
- **Когда:** При проектировании инструкций, запрещающих чтение определенных файлов
- **Как:** Четко разделить:
  - **Чтение содержимого для анализа** — запрещено без явного указания пользователя
  - **Проверка наличия через list_files** — обязательно для верификации KB-зависимостей
- **Почему:** Предотвращает интерпретацию "НЕ ЧИТАЙ" как запрет на list_files, что создает blind spots
- **Формулировка:** "НЕ ЧИТАЙ СОДЕРЖИМОЕ файлов из knowledge-base/ для анализа, если они не указаны пользователем. ИСКЛЮЧЕНИЕ: Проверка наличия (list_files) и чтение метаданных разрешены и обязательны для верификации KB-зависимостей."
- **Применимость:** Все workflow с инструкцией "НЕ ЧИТАЙ файлы из knowledge-base"

---

## Рационализации агента

### Рационализация: Orchestrator игнорирует инструкцию о tracking file
- **Модель:** Все тестированные модели
- **Контекст:** Многоэтапная задача, инструкция v2.4 требует создания `[задача]-track.md`
- **Поведение:** Агент использует `update_todo_list` платформы, не создаёт отдельный tracking file. Не рационализирует явно — просто следует дефолтному потоку.
- **Контрмера (v2.5):** Принято решение не бороться. `update_todo_list` расширен требованием ключевого результата. Tracking file оставлен только для межзапросных задач.
- **Где добавлено:** Orchestrator Mode instructions (v2.5), compliance_architecture_v_2_5.md

---

### Рационализация: Чтение нерелевантных файлов вместо указанных
- **Модель:** qwen3-vl-235b (Code Mode)
- **Контекст:** Donations workflow. Вместо чтения memory bank файлов и входных документов задачи, агент начал читать файлы из knowledge-base/ (матрица санкционных рисков, cover letters АКО, примеры АКО-ассистента), которые не имели отношения к задаче. Также прочитал пустой файл без реакции.
- **Корневая причина:** Отсутствие Шага 0 в workflow. Агент не имел явной инструкции ЧТО читать первым, и заполнял "подготовку" произвольным чтением файлов.
- **Контрмера:** Шаг 0 в workflow с явным списком: (1) index.md, (2) lessons-learned.md, (3) patterns.md, (4) входные документы задачи. Антипаттерн: "НЕ ЧИТАЙ файлы из knowledge-base/, если они не указаны пользователем."
- **Где добавлено:** 5 workflows (donations, gifts-hospitality, ako-validation, doc-coauthoring, ticket-recon).

---

### Рационализация: Blind Spot — вывод об отсутствии KB-файлов без list_files
- **Модель:** Все тестированные модели
- **Контекст:** Анализ workflow-ako-validation.mdc (helicopter view)
- **Поведение:** Агент сделал вывод о критическом отсутствии файлов `АКО_templates_yandex_yango.md` и `references-scope-rules v.2.md`, хотя файлы существовали. Анализ был проведен без использования `list_files` для проверки директории.
- **Корневая причина:** 
  1. Агент полагался на усеченные environment_details вместо явной проверки
  2. Инструкция "НЕ ЧИТАЙ файлы из knowledge-base" была интерпретирована как запрет на list_files
  3. Отсутствие шага верификации KB-зависимостей в workflow
- **Контрмера:**
  1. Добавить Шаг 0.5 "Верификация KB-зависимостей" во все workflow с внешними зависимостями
  2. Пересмотреть формулировку "НЕ ЧИТАЙ" — разрешить list_files для верификации
  3. Добавить пункты в Self-Check для проверки существования KB-файлов
- **Принцип:** Проверка существования критических файлов должна быть явным шагом в workflow, а не предположением на основе ограниченных данных
- **Применимость:** Все workflow, ссылающиеся на внешние KB-файлы. Всегда использовать list_files для верификации наличия перед началом анализа.
- **Где добавлено:** Новый паттерн "Верификация KB-зависимостей через list_files" и "Различие между чтением содержимого и проверкой наличия"
- **Дата:** 2026-02-25
- **Статус:** Закрыто (контрмеры определены)

---

### Ограничение платформы: Architect Mode не поддерживает паузы внутри одного запроса
- **Модели:** qwen3-vl-235b + [вторая модель]
- **Контекст:** Проектирование workflow (G&H review). Двукратное тестирование с усиленными формулировками.
- **Поведение:** Обе модели понимают инструкцию инкрементальной валидации — добавляют её в todo list как отдельный пункт. Но не выполняют: проходят все шаги автономно за один цикл без пауз.
- **Причина:** Дефолтный системный промпт Architect Mode реализует паттерн «plan → execute all → deliver». Наши custom instructions имеют приоритет по тексту, но автономный цикл платформы не прерывается пользовательскими инструкциями о паузах. Это не рационализация конкретной модели — это архитектурное ограничение платформы.
- **Контрмера:** Заменена инкрементальная валидация на двухшаговый процесс: запрос 1 = «покажи план» (без создания файлов), запрос 2 = «создай .mdc». Валидация происходит между запросами, а не внутри одного.
- **Где:** `<architect_compliance>` → v2.3, секция ДВУХШАГОВЫЙ ПРОЦЕСС
- **Дата:** 2026-02-21
- **Статус:** Закрыто (обходное решение)

---

### Рационализация: Создание .md вместо .mdc
- **Модели:** qwen3-vl-235b + [вторая модель]
- **Контекст:** Финальный файл создаётся как .md вместо .mdc
- **Поведение:** Устойчиво на обеих моделях. Инструкция про .mdc игнорируется.
- **Причина:** Модели генерируют .md как более распространённый формат по умолчанию
- **Контрмера:** В п.4 добавлено: «ВАЖНО: расширение — .mdc (не .md). Обязательно для загрузки платформой.» + тестировать после v2.3.
- **Где:** `<architect_compliance>` → п.4 МАСШТАБИРОВАНИЕ
- **Дата:** 2026-02-21
- **Статус:** Открыто (требует повторной проверки после v2.3)

---

### Рационализация: Не предлагает переход в Code Mode (skill chaining)
- **Модели:** qwen3-vl-235b + [вторая модель]
- **Контекст:** После создания файла агент завершает задачу без предложения следующего шага
- **Контрмера:** Усилено ЗАВЕРШЕНИЕ в v2.3
- **Дата:** 2026-02-21
- **Статус:** Открыто (требует повторной проверки)

---

### Рационализация: Не предлагает переход в Code Mode (skill chaining)
- **Модели:** qwen3-vl-235b + [вторая модель]
- **Контекст:** После создания файла агент завершает задачу без предложения следующего шага
- **Контрмера:** Усилено ЗАВЕРШЕНИЕ в v2.3
- **Дата:** 2026-02-21
- **Статус:** Открыто (требует повторной проверки)
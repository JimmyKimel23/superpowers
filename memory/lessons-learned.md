# Lessons Learned — Compliance AI Assistant

## Формат записи
<!-- Дата | Задача | Проблема | Решение | Применимость -->

## Записи

### 2026-02-26 | Thin stub + read_file: модели не выполняют read_file из .mdc как обязательный первый шаг
- **Проблема:** Гипотеза: вынести тело workflow из .mdc в отдельный файл, оставив в .mdc только триггеры + инструкцию `read_file`. Цель — снизить context debt (размер .mdc-файлов в системном промпте).
- **Тест:** A/B сравнение на workflow-ticket-recon. Вариант A (baseline): full-body .mdc. Вариант B: thin stub + fat body через read_file. Вариант B': stub без краткого содержания. Тестовый тикет: TAXIASSIST-593107. Модели: GLM 4.6 Internal, Qwen 3 VL 235B.
- **Результат:** B и B' — провал. Обе модели проигнорировали read_file и импровизировали. Trigger сработал, но модель сразу перешла к MCP-вызовам без чтения инструкций. В B' убрали краткое содержание — не помогло.
- **Корневая причина:** read_file в .mdc = flow control (когда и какой инструмент вызвать первым). Подтверждён принцип Наблюдений 4/7/8: custom instructions контролируют содержание, не поток. Модель выбирает инструмент по собственной логике, игнорируя последовательность из промпта.
- **Контрмера:** Rollback к full-body .mdc. Workflow body = в .mdc, не в отдельном файле.
- **Принцип:** Всё, что должно исполняться — должно быть в системном промпте (.mdc). Делегирование через read_file не работает как обязательный шаг.
- **Применимость:** Все workflow. Не использовать thin stub + read_file как архитектурный паттерн. Для context debt — искать другие решения (hot/cold memory, compression, lean workflows).
- **Связь:** Наблюдения 4, 7, 8 (content vs flow control). Укрепляет принцип: поток определяется платформой.

---

### 2026-02-25 | Blind Spot: Отсутствие list_files приводит к ложным выводам об отсутствии KB-файлов
- **Проблема:** В helicopter view анализе workflow-ako-validation.mdc агент сделал вывод о критическом отсутствии файлов `АКО_templates_yandex_yango.md` и `references-scope-rules v.2.md`, хотя файлы существовали. Анализ был проведен без использования `list_files` для проверки директории.
- **Корневая причина:** 
  1. Агент полагался на усеченные environment_details вместо явной проверки
  2. Инструкция "НЕ ЧИТАЙ файлы из knowledge-base" была интерпретирована как запрет на list_files
  3. Отсутствие шага верификации KB-зависимостей в workflow
- **Решение:**
  1. Добавить Шаг 0.5 "Верификация KB-зависимостей" во все workflow с внешними зависимостями
  2. Пересмотреть формулировку "НЕ ЧИТАЙ" — разрешить list_files для верификации
  3. Добавить пункты в Self-Check для проверки существования KB-файлов
- **Принцип:** Проверка существования критических файлов должна быть явным шагом в workflow, а не предположением на основе ограниченных данных
- **Применимость:** Все workflow, ссылающиеся на внешние KB-файлы. Всегда использовать list_files для верификации наличия перед началом анализа.

---

### 2026-02-24 | WDL bootstrapping: meta-workflow требует формат результата и полный memory layer update (Наблюдение 10)
- **Проблема:** workflow-development.mdc создан через шаги A1-A3+ без прохождения deployment checklist. При ретроспективном bootstrapping test (A4) обнаружены 6 gaps: отсутствие секции «Формат результата», definitions.md не в KB Analysis, отсутствие scenario bank, memory layer не обновлён
- **Корневая причина:** Bootstrapping paradox: meta-workflow создавался без meta-workflow. Формализованный deployment checklist не применялся к собственному созданию
- **Решение:** Ретроспективный bootstrapping test с полным deployment checklist. Закрытие конкретных gaps: добавлены секция «Формат результата», WDL-термины в definitions.md, WDL-паттерны в patterns.md, scenario bank
- **Вывод 1:** Даже при bootstrapping, deployment checklist обнаруживает реальные пробелы (секция «Формат результата» — не очевидно при ручном создании)
- **Вывод 2:** Memory layer update — самый уязвимый шаг: легко пропустить, т.к. воспринимается как «документация», а не «код»
- **Принцип:** Deployment checklist работает. Даже ретроспективное применение к уже созданному workflow обнаруживает gaps, которые не видны автору
- **Применимость:** Все будущие workflow через WDL. Checklist — не формальность, а инструмент обнаружения

---

### 2026-02-23 | Orchestrator маршрутизирует по дефолтным правилам, если workflow не содержит таблицы маршрутизации (Наблюдение 9)
- **Проблема:** G&H workflow запускается через Orchestrator, но Orchestrator направляет в Ask Mode вместо Code → Debug. Workflow выполняется, но в неверном режиме — Ask вместо Code, Debug не вызывается.
- **Корневая причина:** Два конфликтующих правила в Orchestrator: п.5 («следуй workflow, если существует») vs п.2 («для вопросов/консультаций → Ask»). П.2 срабатывает раньше, потому что маршрутизация идёт до проверки наличия workflow. G&H-запрос классифицируется как «вопрос» → Ask.
- **Дополнительный фактор:** workflow-gifts-hospitality не содержал таблицу маршрутизации по режимам (в отличие от workflow-doc-coauthoring). Orchestrator не имел метаданных о том, какие режимы задействовать.
- **Решение (3 фикса):**
  1. Orchestrator п.1-2: приоритетная проверка наличия workflow перед классификацией типа задачи. П.2 стал fallback.
  2. workflow-gifts-hospitality: добавлена таблица маршрутизации (Этапы 0-6 → Code, Этап 7 → Debug) + skill chaining + новый Этап 7 (верификация).
  3. Переименование .md → .mdc (платформа подхватывает rules из *.mdc).
- **Результат:** Тест-кейс (брендированная продукция 8500₽, 12 госслужащих) — Orchestrator → Code (Этапы 0-6) → Debug (Этап 7). Skill chaining сработал, двухэтапная верификация выполнена.
- **Принцип:** Workflow должен содержать не только ЧТО делать, но и В КАКОМ РЕЖИМЕ. Orchestrator не должен угадывать — workflow объявляет свои контракты по режимам.
- **Связь:** Наблюдения 4 (контроль потока), 7 (alwaysApply ≠ исполнение), 8 (todo list vs tracking file). Все формируют единый принцип: workflow = единственный надёжный механизм enforcement.
- **Применимость:** Все workflow, запускаемые через Orchestrator. Проверить workflow-donations и workflow-ako-validation на наличие таблицы маршрутизации.

---

### Урок: Автономные режимы агентных платформ не поддерживают пользовательские паузы
- **Дата:** 2026-02-21
- **Фаза:** 2 (Шаг 7 — Architect Mode)
- **Модели:** qwen3-vl-235b + [вторая модель]
- **Проблема:** Инструкция «остановись и дождись подтверждения после каждой секции» не работает ни на одной из двух протестированных моделей. Модели понимают инструкцию (добавляют в todo), но не выполняют. Усиление формулировок (п.0 КРИТИЧЕСКОЕ ПРАВИЛО, антирационализации, «начни заново») не помогло.
- **Корневая причина:** Architect Mode работает как автономный агент: получает задачу → строит план → выполняет все шаги → выдаёт результат. Этот цикл не прерывается custom instructions. Это ограничение архитектуры платформы, а не промпта.
- **Решение:** Двухшаговый процесс — валидация между запросами, а не внутри одного. Запрос 1 = план без файлов. Запрос 2 = создание .mdc файла после подтверждения.
- **Принцип:** При проектировании инструкций для агентных платформ различай два типа контроля:
  1. **Контроль содержания** (что делать, в каком формате, какие источники) — работает через custom instructions
  2. **Контроль потока** (когда остановиться, какой инструмент использовать) — НЕ работает через custom instructions в автономных режимах. Реализуется через разделение на несколько запросов.

---

### Урок: Формат файла (.mdc vs .md) требует повторного тестирования
- **Дата:** 2026-02-21
- **Проблема:** Обе модели создают .md вместо .mdc несмотря на явную инструкцию
- **Статус:** Открыто. Тестировать после применения v2.3.
- **Если не поможет:** Рассмотреть переименование файла вручную или добавить в двухшаговый процесс явную команду «создай файл gifts-hospitality-review.mdc»

---

### 2026-02-23 | Rules Adaptation — alwaysApply не гарантирует исполнение (Наблюдение 7)
- **Проблема:** `rule-memory-bank-usage.mdc` с `alwaysApply: true` загружен в контекст (подтверждено через Ask Mode — агент перечислил все 8 rules), но при реальной задаче (donations $50,000, Узбекистан) в Code Mode (qwen3-vl-235b) агент не выполнил ни одной инструкции из rule. Вместо обращения к memory bank агент читал нерелевантные файлы (матрица санкционных рисков, cover letters АКО, примеры АКО-ассистента), прочитал пустой файл без реакции, фазу "Подготовка" из rule-single-stage-execution не выполнил.
- **Корневая причина:** Та же, что в Наблюдении 4: `alwaysApply` = видимость в контексте, не исполнение. Custom instructions / rules контролируют содержание (что делать), но не поток (когда и в каком порядке).
- **Решение:** Встроить memory bank check как **Шаг 0** (обязательный, перед текущим Шагом 1) прямо в workflows. Логика: агент следует шагам workflow надёжно (todo list из 7 шагов был корректен даже в провальном тесте), поэтому шаг внутри workflow выполняется надёжнее, чем отдельный rule.
- **Результат контрмеры:** Повторный тест (Architect Mode, GLM 4.6) — Шаг 0 сработал: агент первым делом прочитал index.md, затем patterns.md и lessons-learned.md, затем релевантную политику благотворительности. Нерелевантные файлы не читались.
- **Применимость:** Все workflows. Любая инструкция, которая ДОЛЖНА выполняться — встраивать в workflow, а не оставлять в отдельном rule.
- **Открытый вопрос:** Тест 2 проведён на другой модели (GLM 4.6) и в другом режиме (Architect вместо Code). Требуется повторный тест в Code Mode на qwen3-vl-235b для полной верификации.

---

### 2026-02-23 | Orchestrator: todo list vs tracking file (Наблюдение 8)
- **Проблема:** Инструкция v2.4 в Orchestrator требовала создавать отдельный tracking file (`[задача]-track.md` в `workflows/active/`) для прогресс-трекинга. Агент последовательно игнорировал инструкцию и использовал встроенный `update_todo_list` платформы.
- **Корневая причина:** Та же, что в Наблюдениях 4 и 7. Дефолтный промпт Orchestrator интегрирован с `update_todo_list`. Инструкция «используй другой инструмент» — это попытка контролировать поток, а не содержание. Агент следует дефолтному циклу платформы.
- **Решение (v2.5):** Адаптивный подход — работать С платформой:
  - Внутри одного запроса → `update_todo_list` платформы + обязательный ключевой результат после каждого [X]
  - Межзапросные задачи → tracking file в `workflows/active/` (только когда context reset реально необходим)
- **Новый принцип:** Не пытаться заменить встроенные инструменты платформы кастомными аналогами. Расширять содержание встроенных инструментов (добавить ключевой результат к [X]), а не заменять формат.
- **Применимость:** Все случаи, когда кастомная инструкция конкурирует со встроенным поведением платформы. Решение всегда одно: адаптировать содержание под встроенный инструмент, а не бороться с потоком.
- **Связь:** Наблюдения 4 (контроль потока невозможен), 7 (alwaysApply ≠ исполнение). Все три формируют единый принцип: содержание → контролируемо, поток → определяется платформой.

---

### 2026-02-23 | Rules Adaptation — alwaysApply rules = справочный контекст
- **Проблема:** Ожидание, что `alwaysApply: true` заставит агента автоматически следовать инструкциям rule — не оправдалось.
- **Решение:** Пересмотр стратегии использования rules. `alwaysApply` rules работают как **справочный контекст** (агент видит, может использовать), но НЕ как обязательные процедуры. Для обязательного исполнения — только встраивание в workflow.
- **Применимость:** Все будущие rules. При проектировании новых rules: если инструкция обязательна к исполнению → workflow, если справочная → rule с alwaysApply.

---

### 2026-02-24 | Анализ пожертвований требует проверки альтернативных вариантов и прецедентов (YACHARITY-524)
- **Проблема:** workflow-donations фокусируется только на анализе документов пожертвования, но не учитывает альтернативные варианты (временное пользование, спонсорство) и прецеденты, которые могут упростить процесс.
- **Корневая причина:** Workflow спроектирован для анализа конкретного типа сделки (пожертвование), но не содержит шагов по оценке альтернативных механизмов достижения той же цели.
- **Дополнительные факторы:**
  1. В YACHARITY-517 был успешный прецедент перехода от пожертвования к временному пользованию
  2. Комплаенс-специалист выявил нестандартные формулировки в draфте соглашения
  3. Обсуждались альтернативные варианты (спонсорский договор)
- **Решение:**
  1. Добавить в workflow-donations **Шаг 3.5: Анализ прецедентов и альтернативных вариантов**
  2. Включить проверку на наличие похожих тикетов с альтернативными решениями
  3. Добавить анализ формулировок draфта на предмет нестандартных условий
  4. Включить оценку временного пользования как стандартной альтернативы пожертвованию
- **Результат:** Анализ YACHARITY-524 выявил, что временное пользование (как в YACHARITY-517) является предпочтительным вариантом с точки зрения комплаенс-рисков.
- **Принцип:** Комплаенс-анализ должен рассматривать не только предложенный вариант сделки, но и альтернативные механизмы достижения цели с меньшими рисками.
- **Связь:** Наблюдение о необходимости анализа альтернатив в комплаенс-процессах.
- **Применимость:** Все workflow анализа сделок (donations, sponsorship, contracts). Не ограничиваться анализом предложенного варианта, искать альтернативы.

---

### 2026-02-24 | MCP-интеграция критически важна для полноты анализа (YACHARITY-524)
- **Проблема:** Без доступа к содержимому draфта соглашения анализ был неполным и содержал неверные выводы об отсутствии данных.
- **Корневая причина:** Пользователь предоставил путь к локальному файлу, но файл был пустым. Реальное содержимое было в тикете как вложение.
- **Решение:**
  1. Всегда проверять наличие вложений в тикетах через MCP
  2. Использовать GetAttachment для получения метаданных, но понимать ограничения по содержимому
  3. Если содержимое недоступно через MCP — явно запрашивать у пользователя
  4. Добавить в workflow-donations проверку доступности содержимого документов
- **Результат:** После получения draфта соглашения анализ был дополнен критически важными findings об отсутствии ABC-оговорки и нестандартных формулировках.
- **Принцип:** Полнота анализа зависит от полноты исходных данных. MCP предоставляет доступ к метаданным, но не всегда к содержимому.
- **Применимость:** Все workflow, работающие с тикетами и документами. Обязательно проверять MCP-источники перед анализом.

---

### 2026-02-24 | Комплаенс-специалисты предоставляют критический контекст, который нужно систематизировать
- **Проблема:** Комментарий комплаенс-специалиста содержал ключевые выводы о нестандартных формулировках и рекомендацию по временному пользованию, которые не были очевидны из формального анализа.
- **Корневая причина:** Workflow не содержит шага по сбору и анализу экспертных мнений и комментариев от комплаенс-специалистов.
- **Решение:**
  1. Добавить в workflow-donations **Шаг 6: Анализ экспертных мнений**
  2. Систематически проверять комментарии от комплаенс-специалистов в тикетах
  3. Включать анализ рекомендаций специалистов в findings
  4. Различать формальный анализ документов и экспертную оценку рисков
- **Результат:** Рекомендация комплаенс-специалиста о временном пользовании стала приоритетной в итоговых выводах.
- **Принцип:** Экспертное мнение комплаенс-специалиста имеет приоритет над формальным анализом при выявлении нестандартных рисков.
- **Применимость:** Все комплаенс-workflows. Экспертные мнения должны быть систематически включены в анализ.

---

### 2026-02-24 | WDL-цикл успешно применён для создания workflow-sponsorship.mdc
- **Проблема:** Необходимость создания стандартизированного workflow для анализа спонсорства.
- **Решение:** Применение полного WDL-цикла (Фазы 0-6) для проектирования, тестирования и ввода в эксплуатацию workflow-sponsorship.mdc.
- **Ключевые результаты:**
  1. **Фаза 1 (RESEARCH):** Определён scope: анализ спонсорских запросов, проверка встречных услуг, оценка рисков, формирование рекомендаций.
  2. **Фаза 2 (DESIGN):** Спроектирован 8-этапный workflow с таблицей маршрутизации по режимам.
  3. **Фаза 3 (RED):** Baseline-тестирование выявило, что без workflow агент не структурирует анализ спонсорства.
  4. **Фаза 4 (GREEN):** Создан .mdc файл со всеми обязательными секциями.
  5. **Фаза 5 (REFACTOR):** Pressure testing подтвердил устойчивость к рационализациям.
  6. **Фаза 6 (DEPLOY):** Workflow активирован и интегрирован в систему.
- **Вывод:** WDL-цикл эффективен для создания качественных workflow. Формализованный процесс гарантирует, что workflow адресует реальные потребности, а не гипотетические проблемы.
- **Применимость:** Все будущие workflow должны создаваться через WDL-цикл.

---

### 2026-02-25 | WDL-цикл успешно применён для адаптации workflow-gifts-hospitality.mdc
- **Проблема:** Необходимость адаптации существующего workflow к актуальным правилам System_instruction.md
- **Решение:** Применение полного WDL-цикла (Фазы 0-6) для ревизии и улучшения workflow-gifts-hospitality.mdc
- **Ключевые результаты:**
  1. **Фаза 1 (RESEARCH):** Определён scope: полная интеграция System_instruction.md, улучшение маршрутизации
  2. **Фаза 2 (DESIGN):** Спроектирован обновлённый 7-этапный workflow с таблицей маршрутизации
  3. **Фаза 3 (RED):** Baseline-тестирование выявило 5 ключевых gaps в интеграции System_instruction
  4. **Фаза 4 (GREEN):** Создан обновлённый .mdc файл версии v2.0 с полной интеграцией
  5. **Фаза 5 (REFACTOR):** Pressure testing подтвердил устойчивость к рационализациям
  6. **Фаза 6 (DEPLOY):** Workflow активирован и интегрирован в систему
- **Вывод:** WDL-цикл эффективен не только для создания новых workflow, но и для адаптации существующих к изменяющимся требованиям
- **Применимость:** Все будущие обновления workflow должны проходить через WDL-цикл для гарантии качества

---

### 2026-02-25 | Blind Spot: Отсутствие list_files приводит к ложным выводам об отсутствии KB-файлов
- **Проблема:** В helicopter view анализе workflow-ako-validation.mdc агент сделал вывод о критическом отсутствии файлов `АКО_templates_yandex_yango.md` и `references-scope-rules v.2.md`, хотя файлы существовали. Анализ был проведен без использования `list_files` для проверки директории.
- **Корневая причина:** 
  1. Агент полагался на усеченные environment_details вместо явной проверки
  2. Инструкция "НЕ ЧИТАЙ файлы из knowledge-base" была интерпретирована как запрет на list_files
  3. Отсутствие шага верификации KB-зависимостей в workflow
- **Решение:**
  1. Добавить Шаг 0.5 "Верификация KB-зависимостей" во все workflow с внешними зависимостями
  2. Пересмотреть формулировку "НЕ ЧИТАЙ" — разрешить list_files для верификации
  3. Добавить пункты в Self-Check для проверки существования KB-файлов
- **Принцип:** Проверка существования критических файлов должна быть явным шагом в workflow, а не предположением на основе ограниченных данных
- **Применимость:** Все workflow, ссылающиеся на внешние KB-файлы. Всегда использовать list_files для верификации наличия перед началом анализа.

---

### 2026-02-25 | СИСТЕМНАЯ ПРОБЛЕМА: Парадокс "НЕ ЧИТАЙ" vs "KB First" создает blind spots
- **Проблема:** Инструкция "НЕ ЧИТАЙ файлы из knowledge-base/ ... если они не указаны пользователем" (workflow-ako-validation.mdc, Stage 0) конфликтует с Hard Constraint #7 "KB First: перед рекомендацией ВСЕГДА искать релевантный сценарий в базе знаний". Агент выбирает безопасный путь — не проверяет KB, чтобы не нарушить инструкцию, что приводит к ложным выводам об отсутствии критических файлов.
- **Корневая причина:** Отсутствие различия между "чтением содержимого для анализа" (запрещено) и "проверкой наличия через list_files" (обязательно для верификации зависимостей).
- **Влияние:** 
  - Ложные выводы об отсутствии файлов (АКО_templates_yandex_yango.md, references-scope-rules v.2.md)
  - Невозможность выполнить Stage 4 (Декомпозиция) и Stage 7 (Redline) без эталонных файлов
  - Нарушение Hard Constraint #7 (KB First)
  - Занижение оценки готовности workflow (7.5/10 вместо 9.0/10)
- **Решение (4 контрмеры):**
  1. **Изменение #1:** Добавить Шаг 0.5 "Верификация KB-зависимостей" во все workflow с внешними зависимостями
  2. **Изменение #2:** Пересмотреть формулировку "НЕ ЧИТАЙ" — разрешить list_files для верификации
  3. **Изменение #3:** Добавить пункты в Self-Check для проверки существования KB-файлов
  4. **Изменение #4:** Обновить memory bank (lessons-learned.md, patterns.md)
- **Принцип:** Проверка существования критических файлов должна быть явным шагом в workflow, а не предположением на основе ограниченных данных. Различие между чтением содержимого и проверкой наличия должно быть четко задокументировано.
- **Применимость:** Все workflow, ссылающиеся на внешние KB-файлы (ako-validation, donations, sponsorship, gifts-hospitality, ticket-recon). Всегда использовать list_files для верификации наличия перед началом анализа.

---

### 2026-02-25 | Влияние Инструкции "НЕ ЧИТАЙ" на Blind Spots
- **Проблема:** Инструкция "НЕ ЧИТАЙ файлы из knowledge-base/ ... если они не указаны пользователем" создает парадокс: агент должен проверить наличие KB-файлов (Hard Constraint #7), но не может это сделать, чтобы не нарушить инструкцию.
- **Механизм провала:**
  1. **Stage 0 workflow-ako-validation.mdc** гласит: "НЕ ЧИТАЙ файлы из knowledge-base/ ... если они не указаны пользователем"
  2. **Файлы не были указаны пользователем напрямую** (только директория)
  3. **Агент интерпретирует** это как запрет на list_files директории
  4. **Результат:** Агент не проверяет наличие файлов и делает ложный вывод об отсутствии
- **Техническая цепочка ошибки:**
  ```
  Пользовательский запрос → Чтение 4 файлов (workflow, SKILL, examples, scenarios) 
  → Отсутствие list_files для директории → Усеченные environment_details 
  → Вывод "файлы отсутствуют" → Ошибка
  ```
- **Контрмеры:**
  1. **Разрешить list_files:** "НЕ ЧИТАЙ СОДЕРЖИМОЕ файлов из knowledge-base/ для анализа, если они не указаны пользователем. ИСКЛЮЧЕНИЕ: Проверка наличия (list_files) и чтение метаданных разрешены и обязательны для верификации KB-зависимостей."
  2. **Добавить Шаг 0.5:** Явный шаг верификации KB-зависимостей во всех workflow
  3. **Self-Check:** Добавить пункты проверки существования файлов
- **Применимость:** Все workflow с инструкцией "НЕ ЧИТАЙ файлы из knowledge-base". Всегда использовать list_files для верификации наличия перед началом анализа.

---

### 2026-02-25 | Конкретные Изменения в Процессах (Изменение #1 - #4)

#### Изменение #1: Добавить Шаг 0.5 "Верификация KB-Зависимостей" во все workflow

**В какие файлы добавить:** Все workflow с внешними KB-зависимостями (ako-validation, donations, sponsorship, gifts-hospitality, ticket-recon)

**Формат добавления (вставить после Stage 0, перед Stage 1):**

```markdown
### ЭТАП 0.5: Верификация KB-Зависимостей

**Текущее состояние:** Memory bank проверен, но необходимо убедиться в наличии всех внешних KB-файлов, на которые ссылается workflow.

**Инструкции по выполнению:**
1. Выполнить `list_files` для директории `knowledge-base/processes/[workflow-specific-dir]/`
2. Проверить наличие следующих файлов:
   - `АКО_templates_yandex_yango.md` (если применимо)
   - `references-scope-rules v.2.md` (если применимо)
   - `[другие специфичные файлы]` (указать конкретно для каждого workflow)
3. Если файл отсутствует → **STOP** и сообщить пользователю: "Критический KB-файл [имя] не найден. Workflow не может выполняться без него."
4. Если файл присутствует → продолжить к Шагу 1

**Итог шага:** Все KB-зависимости верифицированы и доступны для использования.
```

**Почему это работает:** Явный шаг с конкретным инструментом (`list_files`) преодолевает парадокс "НЕ ЧИТАЙ" — это не чтение содержимого, а проверка наличия.

---

#### Изменение #2: Пересмотреть Инструкцию "НЕ ЧИТАЙ" в Stage 0

**Текущая формулировка (проблемная):**
```
5. НЕ ЧИТАЙ файлы из knowledge-base/ и других директорий, если они не указаны пользователем как входные документы
```

**Новая формулировка (безопасная):**
```
5. НЕ ЧИТАЙ СОДЕРЖИМОЕ файлов из knowledge-base/ для анализа, если они не указаны пользователем. 
   ИСКЛЮЧЕНИЕ: Проверка наличия (list_files) и чтение метаданных разрешены и обязательны для верификации KB-зависимостей.
```

**Разница:** Четкое разделение между "чтением содержимого для анализа" (запрещено) и "проверкой наличия для верификации" (обязательно)

---

#### Изменение #3: Добавить Валидацию в Self-Check

**В workflow-ako-validation.mdc добавить пункты в Self-Check (после строки 478):**

```markdown
| 19 | Все KB-файлы, указанные в workflow, существуют? |
| 20 | Выполнена верификация KB-зависимостей через list_files? |
```

**Почему:** Self-Check — единственный механизм, который агент выполняет релевантно перед завершением задачи.

---

#### Изменение #4: Обновить Memory Bank

**Что обновить:**
1. **`.codeassistant/memory/lessons-learned.md`** — добавить запись о blind spot (строки 1-15)
2. **`.codeassistant/memory/patterns.md`** — добавить два новых паттерна:
   - "Верификация KB-зависимостей через list_files" (строки 187-194)
   - "Различие между чтением содержимого и проверкой наличия" (строки 196-204)

**Приоритет:** ВЫСОКИЙ — предотвращает повторение ошибки в будущем

---

### 2026-02-25 | Обновление Memory Bank

**Что обновить:**
1. **`.codeassistant/memory/lessons-learned.md`** — добавить запись о blind spot (строки 1-15)
2. **`.codeassistant/memory/patterns.md`** — добавить два новых паттерна:
   - "Верификация KB-зависимостей через list_files" (строки 187-194)
   - "Различие между чтением содержимого и проверкой наличия" (строки 196-204)

**Приоритет:** ВЫСОКИЙ — предотвращает повторение ошибки в будущем

**Почему это критично для Memory Bank:**

**Принцип из `lessons-learned.md` (строка 14):**
> "Deployment checklist работает. Даже ретроспективное применение к уже созданному workflow обнаруживает gaps, которые не видны автору"

**Наш случай:** Ретроспективный анализ blind spot обнаружил системную уязвимость, которую нужно задокументировать, чтобы другие workflow не пострадали.

---

### 2026-02-25 | Сводка Изменений для Исправления Системной Проблемы

**Статус:** СИСТЕМНАЯ ПРОБЛЕМА, требует 4 изменения

| # | Изменение | Где применить | Приоритет | Статус |
|---|-----------|---------------|-----------|--------|
| 1 | Добавить Шаг 0.5 "Верификация KB-зависимостей" | workflow-ako-validation.mdc + другие workflow | ВЫСОКИЙ | Не применено |
| 2 | Пересмотреть формулировку "НЕ ЧИТАЙ" | workflow-ako-validation.mdc, Stage 0 | ВЫСОКИЙ | Не применено |
| 3 | Добавить пункты в Self-Check | workflow-ako-validation.mdc | ВЫСОКИЙ | Не применено |
| 4 | Обновить memory bank (lessons-learned.md, patterns.md) | .codeassistant/memory/ | ВЫСОКИЙ | Частично применено (patterns.md обновлен) |

**Ожидаемый эффект после применения всех изменений:**
- ✅ Предотвращение ложных выводов об отсутствии KB-файлов
- ✅ Прозрачность всех KB-зависимостей через явную верификацию
- ✅ Соблюдение Hard Constraint #7 (KB First)
- ✅ Повышение оценки готовности workflow с 7.5 до 9.0/10

**Действия пользователя:** Применить Изменения #1-#3 к workflow-ako-validation.mdc и другим affected workflow. Изменение #4 уже применено к patterns.md, осталось добавить запись в lessons-learned.md.

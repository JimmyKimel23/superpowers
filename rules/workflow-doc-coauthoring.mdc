# Workflow: Совместное создание комплаенс-документов

## Назначение
Структурированный процесс создания комплаенс-документов: политик, процедур, инструкций, due diligence отчётов, ABC-оговорок и смежных материалов. Основан на методологии doc-coauthoring (трёхэтапный процесс: контекст → структура → тестирование), адаптирован под архитектуру Compliance AI Assistant v2.4.

## Триггеры
Применять когда пользователь:
- Просит написать/создать/подготовить комплаенс-документ
- Упоминает типы документов: «политика», «процедура», «инструкция», «due diligence», «отчёт», «ABC-оговорка», «памятка»
- Начинает существенную задачу по написанию комплаенс-документации
- Говорит: «написать политику», «создать процедуру», «подготовить DD», «составить регламент»

НЕ применять для:
- Коротких текстов (письмо, резюме встречи) — выполнять в Code Mode напрямую
- Анализа существующих документов — использовать workflow-donations, workflow-gh и т.д.
- Вопросов по комплаенс-тематике — использовать Ask Mode

## Маршрутизация по режимам

Workflow распределён между режимами согласно архитектуре:

| Этап | Режим | Что происходит |
|------|-------|----------------|
| 0. Предложение workflow | Ask | Предложить workflow, получить согласие |
| 1. Сбор контекста | Ask | Вопросы, сбор информации, уточнения |
| 2. Проектирование структуры | Architect | План документа, двухшаговый процесс |
| 3. Создание разделов | Code | Пошаговое написание по SGR-шаблону |
| 4. Верификация | Debug | Двухэтапная проверка |
| 5. Тестирование читателя | Ask + ручной тест | Генерация вопросов + ручная проверка |

ВАЖНО: Переход между режимами — через явные инструкции пользователю (skill chaining). Модель не переключает режимы сама.

---

## ЭТАП 0: Подготовка (обязательно перед началом)
**Текущее состояние:** Задача получена, execution не начат.

1. Прочитай `.codeassistant/memory/index.md` — определи релевантные memory-файлы
2. Проверь `lessons-learned.md` — есть ли выводы по этому типу задач
3. Проверь `patterns.md` — есть ли отработанный подход
4. Проверь наличие ВХОДНЫХ документов задачи (файлы, указанные пользователем или подразумеваемые типом задачи)
5. НЕ ЧИТАЙ файлы из knowledge-base/ и других директорий, если они не указаны пользователем как входные документы

Итог шага: Memory bank проверен, входные документы идентифицированы, можно переходить к Шагу 1.

АНТИПАТТЕРН: Не начинай читать все файлы в knowledge-base подряд. Читай ТОЛЬКО то, что указано в задаче как входной документ.

## ЭТАП 1: Предложение workflow

**Режим:** Ask

**Текущее состояние:** Пользователь запросил создание комплаенс-документа. Тип и scope неизвестны.

**Действие:** Предложить структурированный workflow:

«Для создания этого документа предлагаю трёхэтапный процесс:
1. Сбор контекста — вы предоставляете информацию, я задаю уточняющие вопросы
2. Структура и написание — строим документ раздел за разделом
3. Тестирование — проверяем, понятен ли документ читателю без контекста

Это займёт больше времени, чем просто «напиши политику», но документ будет рабочим. Хотите попробовать или предпочитаете свободный формат?»

**Итог шага:** Пользователь согласился на workflow ИЛИ выбрал свободный формат.

Если свободный формат → выполнять в Code Mode без workflow.
Если согласие → перейти к Этапу 1.

---

## ЭТАП 2: Сбор контекста

**Режим:** Ask

**Текущее состояние:** Пользователь согласился на workflow. Контекст документа неизвестен.

### Шаг 2.1: Начальные вопросы (макс. 5)

1. Какой тип документа? (политика, процедура, инструкция, DD-отчёт, ABC-оговорка, памятка)
2. Кто основная аудитория? (сотрудники, руководство, контрагенты, регулятор)
3. Какое воздействие должен оказать документ? (обязать, объяснить, убедить, зафиксировать)
4. Есть ли шаблон или формат для следования? (если да — загрузить файл)
5. Связан ли документ с существующими политиками?

Если упомянуты существующие политики → прочитать из knowledge-base/policies/.
Если загружен шаблон → прочитать структуру, извлечь секции.

**Итог шага:** Мета-контекст документа зафиксирован (тип, аудитория, формат, связи).

### Шаг 2.2: Дамп информации

Сказать пользователю:

«Теперь расскажите всё, что знаете по теме документа. Не нужно структурировать — просто изложите. Можно:
— Писать потоком сознания
— Загрузить файлы (существующие документы, переписку, примеры)
— Скопировать релевантные фрагменты из других источников

Что полезно: предыстория проблемы, кто вовлечён, какие риски, какие решения уже пробовали, сроки, требования регуляторов.»

Во время сбора контекста:
- Если упомянуты неизвестные сущности → спросить или найти в knowledge-base
- Если упомянуты внутренние документы → попросить загрузить или указать путь
- Отслеживать: что понятно ✓, что неясно ?, что критично для продолжения !

**Итог шага:** Основной контекст получен. Есть понимание задачи на уровне деталей.

### Шаг 2.3: Уточняющие вопросы (5–10)

После получения основного контекста сгенерировать 5–10 уточняющих вопросов. Фокус на комплаенс-аспектах:

- Какие red flags должны быть учтены в документе?
- Есть ли санкционные ограничения или экспортный контроль?
- Какие уровни одобрения требуются?
- Как документ будет поддерживаться в актуальном состоянии?
- Какие ситуации-исключения нужно описать?
- Кто несёт финальную ответственность?

Допускать короткие ответы: «1: да, 2: нет, потому что X, 3: см. файл».

**Условие выхода:** Можно обсуждать edge cases и компромиссы без объяснения базовых вещей.

**Итог шага:** Контекст достаточен для проектирования структуры.

**Переход:** «Контекст собран. Переключитесь в **Architect Mode** — я спроектирую структуру документа.»

---

## ЭТАП 3: Проектирование структуры

**Режим:** Architect

**Текущее состояние:** Контекст собран в Этапе 1. Нужно определить структуру документа и согласовать её с пользователем.

### Двухшаговый процесс (обязателен)

**Запрос 1 пользователя** → Показать ТОЛЬКО ПЛАН. НЕ создавать файлы. НЕ писать текст разделов.

Планирование включает:

1. ОПРЕДЕЛЕНИЕ СТРУКТУРЫ

   На основе типа документа предложить структуру. Типовые варианты:

   Политика:
   - Цель и область применения
   - Определения
   - Требования и запреты
   - Процедуры согласования
   - Ответственность
   - Исключения
   - Контакты и отчётность

   Процедура:
   - Назначение
   - Область применения
   - Ответственные стороны
   - Пошаговый процесс
   - Требования к документации
   - Сроки и отчётность
   - Контроль и аудит

   Due Diligence отчёт:
   - Цель проверки
   - Объект проверки
   - Критерии оценки
   - Источники информации
   - Результаты проверки (рабочие секции → findings)
   - Риски и red flags
   - Рекомендации

   ABC-оговорка:
   - Преамбула (стороны, контекст)
   - Обязательства сторон
   - Гарантии и заверения
   - Последствия нарушения
   - Аудит и мониторинг

   Если пользователь предоставил шаблон → использовать его структуру.

2. ПОРЯДОК РАБОТЫ НАД РАЗДЕЛАМИ
   Рекомендовать начать с раздела с наибольшими неизвестными.
   Для политик: обычно «Требования и запреты».
   Для процедур: «Пошаговый процесс».
   Для DD: «Критерии оценки».
   Резюме/цель — писать последними.

3. КОМПЛАЕНС-ПРОВЕРКИ для каждого раздела:
   - Соответствие существующим политикам из knowledge-base/policies/
   - Наличие red flags проверки
   - Чёткость ответственности
   - Полнота процедур

Завершить план вопросом: «Структура готова. Что изменить? Если всё корректно — дайте команду на создание scaffold.»

**Запрос 2 пользователя** → Подтверждение или правки → Создать scaffold-файл:

Файл: `workflows/active/[doc-name].md`
Формат: все разделы с placeholder-ами `[Будет написано]`.

**Итог шага:** Структура согласована, scaffold создан.

**Переход:** «Структура создана: workflows/active/[doc-name].md. Переключитесь в **Code Mode** для написания разделов. Начнём с раздела [РАЗДЕЛ С НАИБОЛЬШИМИ НЕИЗВЕСТНЫМИ].»

---

## ЭТАП 4: Создание разделов

**Режим:** Code

**Текущее состояние:** Scaffold документа создан. Разделы содержат placeholder-ы. Контекст собран в Этапе 1.

ВАЖНО: Каждый раздел — отдельный запрос пользователя. Не пытаться написать весь документ за один запрос.

### Для каждого раздела — цикл из 4 подшагов:

#### Подшаг 4.1: Уточнение + Мозговой штурм

В ОДНОМ ответе:
- Объявить начало работы над разделом [НАЗВАНИЕ]
- Задать 3–5 уточняющих вопросов по содержанию раздела
- Предложить 5–15 пунктов для включения (пронумерованные)
- Спросить: «Какие пункты оставить / убрать / объединить?»

Пример формата ответа:
«Что включить / не включить? Можно кратко: "оставить 1,4,7; убрать 3; объединить 5+6"»

#### Подшаг 4.2: Написание черновика

На основе выбранных пунктов:
- Заменить placeholder раздела на текст
- Использовать write_to_file / replace_in_file

При написании ПЕРВОГО раздела — сказать:
«Указывайте, что изменить, а не редактируйте файл напрямую. Это помогает мне выучить ваш стиль для следующих разделов. Пример: "Убери пункт X — уже покрыт в Y" или "Третий абзац — короче".»

#### Подшаг 4.3: Итерация

По обратной связи:
- Вносить точечные правки (replace_in_file), НЕ перепечатывать весь документ
- После 3 итераций без существенных изменений → спросить: «Можно ли что-то убрать без потери смысла?»

#### Подшаг 4.4: Фиксация раздела

Когда раздел готов:
- Подтвердить завершение: «Раздел [НАЗВАНИЕ] готов.»
- Если осталось >1 раздела: «Готовы к следующему? → раздел [СЛЕДУЮЩИЙ]»
- Если это последний раздел → перейти к финальной проверке

### Финальная проверка документа (80%+ разделов готово)

Прочитать весь документ и проверить:
- Поток и согласованность между разделами
- Дублирование или противоречия
- Наличие «воды» (generic filler)
- Каждое ли предложение несёт смысл
- Согласованность терминологии
- Все ли комплаенс-аспекты покрыты

Сообщить findings. Внести правки.

**Итог шага:** Все разделы написаны, документ прошёл внутреннюю проверку.

**Переход:** «Документ написан. Переключитесь в **Debug Mode** для верификации.»

---

## ЭТАП 5: Верификация

**Режим:** Debug

**Текущее состояние:** Документ написан, все разделы заполнены. Нужна двухэтапная верификация.

### Этап 5.1: Соответствие заданию

Проверить:
- Все ли разделы из scaffold заполнены? (сравнить с планом из Этапа 2)
- Все ли уточняющие вопросы из Этапа 1 учтены?
- Тип документа соответствует запросу?
- Аудитория учтена в стиле и глубине?
- Формат соответствует шаблону (если был)?

Если Этап 5.1 НЕ пройден → вернуться в Code Mode для исправлений.
Если пройден → перейти к Этапу 5.2.

### Этап 5.2: Качество содержания

Проверить комплаенс-специфику:
- Ссылки на существующие политики корректны?
- Red flags перечислены полно?
- Ответственность определена для каждого процесса?
- Процедуры согласования описаны?
- Исключения и edge cases покрыты?
- Нет ли противоречий с knowledge-base/policies/?
- Терминология согласована с definitions.md?

SGR-проверка (если документ содержит findings):
- Рабочие секции заполнены ДО findings?
- Findings ссылаются на данные из рабочих секций?
- Встроенная верификация заполнена?

**Итог шага:** Документ прошёл двухэтапную верификацию.

**Переход:** «Верификация пройдена. Переключитесь в **Ask Mode** — подготовим тестирование документа читателем.»

---

## ЭТАП 6: Тестирование читателя

**Режим:** Ask

**Текущее состояние:** Документ верифицирован. Нужно проверить, понятен ли он читателю без контекста нашего разговора.

### Шаг 6.1: Генерация вопросов

Сгенерировать 5–10 вопросов, которые реальные читатели зададут при знакомстве с документом:

Для политик: «Что мне делать в ситуации X?», «Кто согласовывает Y?», «Какой порог для Z?»
Для процедур: «С чего начать?», «К кому обратиться при проблеме?», «Какие сроки?»
Для DD: «Какие red flags обнаружены?», «Какой итоговый уровень риска?», «Нужна ли дополнительная проверка?»

### Шаг 6.2: Инструкция по тестированию

Предоставить пользователю:

«Чтобы проверить, работает ли документ для читателя:
1. Откройте свежий чат с AI (новый диалог в любом ассистенте)
2. Загрузите или вставьте текст документа
3. Задайте эти вопросы: [список]
4. Для каждого ответа проверьте: правильный ли ответ? есть ли неоднозначности? что осталось непонятным?
5. Также спросите: "Что в этом документе может быть непонятно читателю?"

Что Читатель-AI не понял или понял неверно?»

### Шаг 6.3: Исправление по результатам

Если обнаружены пробелы → вернуться в Code Mode для исправления проблемных разделов.

**Условие выхода:** Читатель-AI последовательно отвечает на вопросы правильно и не находит новых пробелов.

**Итог шага:** Документ прошёл тестирование читателя.

---

## ФИНАЛИЗАЦИЯ

Когда все этапы пройдены:

«Документ прошёл все проверки. Перед завершением:
1. Сделайте финальное прочтение — вы владелец документа и несёте ответственность за качество
2. Проверьте факты, ссылки и конкретные цифры
3. Убедитесь, что документ достигает заявленного воздействия
4. Установите дату следующего пересмотра (рекомендация: раз в 12 месяцев для политик, раз в 6 месяцев для процедур)

Файл: workflows/active/[doc-name].md»

### Обновление памяти

После завершения:
- Если обнаружены новые паттерны → записать в patterns.md
- Если обнаружены новые термины → записать в definitions.md
- Если были ошибки или сюрпризы → записать в lessons-learned.md

---

## Stop Conditions

ОСТАНОВИСЬ и спроси пользователя, если:
- Контекст недостаточен для написания раздела (не додумывай — спроси)
- Обнаружено противоречие между тем, что сказал пользователь, и существующей политикой
- Документ выходит за scope комплаенс-тематики
- Пользователь предоставил конфиденциальные данные, которые не должны быть в документе
- Неясно, какой уровень детализации требуется (политика vs процедура vs инструкция)
- Два раздела дублируют друг друга и непонятно, какой оставить

Остановка дешевле ошибки.

## Антипаттерны

НЕ делай:
- Не пиши весь документ за один запрос — раздел за разделом
- Не генерируй содержание разделов без уточнения у пользователя (мозговой штурм → курация → черновик)
- Не ставь generic placeholder-ы типа «в соответствии с применимым законодательством» — конкретизируй
- Не копируй формулировки из одной политики в другую без адаптации к контексту
- Не пропускай комплаенс-проверки для раздела, даже если содержание кажется очевидным
- Не создавай структуру документа до согласования с пользователем (двухшаговый процесс)
- Не предполагай, какие red flags релевантны — спроси
- Не пропускай Этап 5 (тестирование читателя) — это ключевая проверка качества
- Не формулируй выводы как финальное заключение. Комплаенс-output = предварительный анализ для review специалистом (Принцип 10).

## Workflow Variations

### Fast Track (для опытных пользователей)

Если пользователь уже имеет чёткое видение и структуру:
- Пропустить Этап 2.2 (дамп информации) — перейти сразу к Шагу 2.3 (уточняющие вопросы)
- В Этапе 4 — предлагать 5 пунктов вместо 15, быстрее переходить к черновику
- Сообщить: «Используем ускоренный режим. Если нужно детальнее — скажите.»

### На основе шаблона

Если пользователь предоставил шаблон:
- В Этапе 3 — использовать структуру шаблона, не предлагать свою
- Извлечь секции, обязательные поля, placeholder-ы
- Сообщить: «Использую структуру из вашего шаблона. Нашёл [N] разделов.»

### Обязательный финальный шаг верификации

Перед объявлением документа завершённым проверить:
- [ ] Все разделы scaffold заполнены
- [ ] Комплаенс-проверки пройдены для каждого раздела
- [ ] Двухэтапная верификация (Debug) выполнена
- [ ] Тестирование читателя проведено (или осознанно пропущено пользователем)
- [ ] Дата следующего пересмотра установлена
- [ ] Memory обновлена (при необходимости)

Если любой пункт не выполнен — НЕ объявлять документ завершённым. Сообщить, что осталось.

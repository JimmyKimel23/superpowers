# Workflow: Разработка workflow (WDL Meta-Workflow)

## Назначение
Формализованный R&D-процесс для проектирования, тестирования и ввода в эксплуатацию workflow в рамках Compliance AI Assistant v2.5. Гарантирует, что каждый новый workflow проходит структурированный цикл от исследования до deployment, а не деплоится ad hoc.

**Контракт:** contract-workflow-development-lifecycle.md
**Методология:** wdl-methodology-draft-v0_1.md

## Версия
v1.0 (Фаза A, шаг A3)

## Триггеры
Применять когда пользователь:
- Запрашивает создание нового workflow («создай workflow», «спроектируй workflow», «разработай workflow для…»)
- Упоминает «WDL-цикл» или «R&D-процесс для workflow»
- Говорит «нужен новый workflow для [задачи]»
- Просит «добавить workflow в систему»

НЕ применять когда:
- Редактирование существующего workflow → фаза UPDATE (секция в конце этого документа)
- Исполнение workflow → обычная маршрутизация Orchestrator
- Вопрос о методологии WDL → Ask Mode, ссылка на wdl-methodology-draft-v0_1.md

---

## Маршрутизация по режимам

| Фаза | Режим | Что происходит |
|------|-------|----------------|
| 0. Подготовка | Ask | Memory bank, проверка контракта |
| 0.5 Track Selection | Ask | Complexity assessment → Lightweight / Full |
| 1. RESEARCH | Ask | Scope, KB-анализ, scenario bank |
| 2. DESIGN | Architect | План workflow (двухшаговый процесс) |
| 3. RED | Orchestrator → * | Baseline: прогон без workflow |
| 4. GREEN | Code | Создание .mdc, прогон scenario bank |
| 5. REFACTOR | Debug | Pressure testing, compatibility check |
| 6. DEPLOY | Debug → Code | Checklist, финализация, активация |

Переход между режимами — через явные инструкции пользователю (skill chaining). Модель не переключает режимы сама.

---

## Шаг 0: Подготовка (обязательно перед началом)

**Текущее состояние:** Получен запрос на создание нового workflow.

1. Прочитай `.codeassistant/memory/index.md` — определи релевантные memory-файлы
2. Проверь `lessons-learned.md` — есть ли наблюдения по созданию workflow
3. Проверь `patterns.md` — есть ли применимые паттерны
4. Проверь наличие **контракта** на создаваемый workflow (или scope statement)

**STOP:** Если контракт / scope statement отсутствует — остановись. Предложи пользователю сначала оформить scope: что workflow должен делать, какой deliverable, какие триггеры. Без scope нельзя начинать RESEARCH.

**Итог шага:** Memory bank проверен, контракт/scope идентифицирован, можно определять трек.

АНТИПАТТЕРН: Не начинай проектирование workflow «из головы» без scope. Это главная причина дефектов (Наблюдение 9).

---

## Фаза 0.5: Track Selection (Ask Mode)

**Текущее состояние:** Scope/контракт доступен. Нужно определить трек — Lightweight или Full.

**Критерии выбора:**

| Параметр | Lightweight | Full |
|----------|-------------|------|
| Шагов в workflow | ≤ 5 | > 5 |
| Режимы | Один | Multi-mode |
| Skill chaining | Нет | Да |
| KB-зависимости | Минимальные | Множественные |
| Пример | workflow-ticket-recon | workflow-gifts-hospitality |

Если хотя бы 2 параметра указывают на Full → Full Track.

**Итог шага:** Трек определён. Объём всех последующих фаз зависит от этого решения.

---

## Фаза 1: RESEARCH (Ask Mode)

**Текущее состояние:** Трек определён, scope/контракт доступен.

### R1. Scope Definition

→ Текущее состояние: есть контракт/scope, нужно формализовать 4 вопроса.

Ответить на:
1. **Contract:** Что workflow должен делать? (1-3 предложения)
2. **Triggers:** Кто инициирует и какими словами? (список формулировок)
3. **Deliverable:** Какой expected output? (файл, отчёт, чеклист, рекомендация)
4. **Routing:** Какие режимы задействованы и в каком порядке?

→ Итог: scope statement зафиксирован.

### R2. KB Analysis

→ Текущее состояние: scope определён, нужен контекст из memory bank.

- Проверить `lessons-learned.md` — релевантные наблюдения для данного типа задач
- Проверить `patterns.md` — применимые паттерны (маршрутизация, SGR, Step 0)
- Проверить `definitions.md` — нужны ли новые термины для создаваемого workflow
- Проверить существующие workflow — есть ли аналоги, из которых можно взять структуру (НЕ копировать — AP-6)
- Проверить knowledge-base — какие KB-файлы потребуются workflow

→ Итог: контекст собран, KB-зависимости идентифицированы.

### R3. Scenario Bank

→ Текущее состояние: scope + контекст готовы, нужны тестовые сценарии.

Создать scenario bank по шаблону `workflows/templates/scenario-bank-template.md`:

| Для Lightweight | Для Full |
|-----------------|----------|
| 1 positive scenario | 3+ positive scenarios |
| 1 negative scenario | 3+ negative scenarios |
| 1 edge case | 2+ edge cases |
| — | 2+ pressure scenarios |
| **Итого: 3** | **Итого: 10+** |

Каждый сценарий: input (запрос) → expected behavior (что должен сделать агент) → expected output (результат).

→ Итог: scenario bank создан, сохранён как `workflows/scenarios/scenario-bank-{workflow-name}.md`.

### R4. Gate RESEARCH → DESIGN

- [ ] Scope statement зафиксирован (4 вопроса отвечены)
- [ ] KB-зависимости идентифицированы
- [ ] Scenario bank создан (min 3 сценария для Lightweight, 10+ для Full)
- [ ] Трек подтверждён (Lightweight / Full)

**Переход:** «RESEARCH завершён. Переключитесь в **Architect Mode** для проектирования workflow.»

---

## Фаза 2: DESIGN (Architect Mode)

**Текущее состояние:** RESEARCH завершён, scope + scenario bank готовы. Применяется двухшаговый процесс Architect.

### D1. План workflow (Step 1 — план без файлов)

→ Текущее состояние: scope + scenario bank из RESEARCH.

Определить:
1. **Этапы workflow** — название, назначение, входы/выходы каждого этапа
2. **Маршрутизация** — таблица «Этап → Режим → Что происходит»
3. **Skill chaining** — инструкции перехода между режимами
4. **Stop conditions** — когда агент должен остановиться и спросить
5. **Антипаттерны** — чего НЕ делать
6. **SGR-структура** — «Текущее состояние» и «Итог шага» для каждого этапа
7. **Формат итогового артефакта** — структура выходного файла/отчёта

→ Итог: план workflow (текстовый, без создания файлов). Предъявить пользователю.

### D2. Валидация плана (Step 2 — только Full Track)

→ Текущее состояние: план создан, ожидает проверки.

Пользователь проверяет:
- Все этапы логичны и полны?
- Маршрутизация покрывает все этапы?
- SGR-структура присутствует в каждом шаге?
- Stop conditions адекватны?

Для Lightweight: пользователь подтверждает план кратко, без формальной валидации.

→ Итог: план подтверждён (или скорректирован).

### D3. Compatibility Check

→ Текущее состояние: план подтверждён, нужна проверка совместимости.

Проверить:
- **Base Layer:** workflow не противоречит принципам 1–10?
- **Mode Extensions:** инструкции workflow не конфликтуют с поведением режимов?
- **Orchestrator routing:** триггеры не перехватывают запросы других workflow и не конфликтуют с дефолтной маршрутизацией?
- **Platform constraints:** учтены ограничения (no subagents, manual mode switch, chat-based)?
- **KB-зависимости:** все необходимые файлы knowledge base доступны?

→ Итог: compatibility report (pass / issues found + план исправления).

### D4. Gate DESIGN → RED

- [ ] План workflow зафиксирован
- [ ] Таблица маршрутизации определена
- [ ] Compatibility check пройден (или issues задокументированы с планом исправления)
- [ ] Пользователь подтвердил план (Full Track)

---

## Фаза 3: RED (Orchestrator → целевые режимы)

**Текущее состояние:** План workflow подтверждён, scenario bank готов. Workflow (.mdc) ещё НЕ создан.

**Ключевой принцип:** No workflow without RED phase. Нельзя писать workflow, не увидев, как агент проваливается без него.

### RED-1. Подготовка среды

→ Текущее состояние: plan + scenario bank готовы.

- Убедиться, что целевой .mdc файл НЕ существует в `.codeassistant/rules/`
- Подготовить входные данные для сценариев из scenario bank

→ Итог: среда готова к baseline-тестированию.

### RED-2. Прогон сценариев

→ Текущее состояние: среда готова, workflow отсутствует.

Для каждого сценария из scenario bank:
1. Отправить запрос через Orchestrator (как обычный пользователь)
2. Зафиксировать: какой режим выбрал Orchestrator?
3. Зафиксировать: что агент сделал? (шаги, рассуждения)
4. Зафиксировать: какие отклонения от expected behavior?
5. Зафиксировать: какие рационализации использовал агент?

Количество сценариев: Lightweight — 2-3, Full — 5+.

→ Итог: baseline зафиксирован для каждого сценария.

### RED-3. Gap Analysis

→ Текущее состояние: baseline результаты собраны.

Заполнить таблицу:

| Сценарий | Expected | Actual | Gap | Что workflow должен адресовать |
|----------|----------|--------|-----|-------------------------------|
| ... | ... | ... | ... | ... |

→ Итог: gap analysis готов — workflow будет адресовать конкретные провалы, а не гипотетические.

### RED-4. Gate RED → GREEN

- [ ] Baseline зафиксирован для всех сценариев (min 2 для Lightweight, 5 для Full)
- [ ] Gap analysis заполнен
- [ ] Понятно, какие конкретные проблемы workflow должен решить

**Переход:** «RED завершён. Переключитесь в **Code Mode** для создания .mdc файла.»

---

## Фаза 4: GREEN (Code Mode)

**Текущее состояние:** RED завершён, gaps идентифицированы, план workflow подтверждён.

### GR-1. Создание .mdc файла

→ Текущее состояние: план + gap analysis готовы.

Создать .mdc файл по плану из DESIGN (D1), включая все обязательные секции:
- Назначение
- Триггеры (positive + negative)
- Версия
- Маршрутизация по режимам (таблица)
- Шаг 0 (подготовка)
- Этапы с SGR-структурой (текущее состояние → инструкции → итог шага)
- Stop conditions
- Антипаттерны
- Hard constraints
- Self-check

Workflow должен адресовать каждый gap из RED-3.

→ Итог: .mdc файл создан (пока в рабочей директории, не в rules/).

### GR-2. Прогон scenario bank

→ Текущее состояние: .mdc файл создан, размещён в `.codeassistant/rules/`.

Для каждого сценария из scenario bank:
1. Отправить запрос через Orchestrator
2. Зафиксировать: workflow распознан? Маршрутизация корректна?
3. Зафиксировать: шаги выполнены по SGR-структуре?
4. Зафиксировать: результат соответствует expected?
5. Сравнить с RED baseline — gap закрыт?

→ Итог: результаты GREEN-прогона зафиксированы.

### GR-3. Результаты

→ Текущее состояние: все сценарии прогнаны.

Заполнить таблицу:

| Сценарий | Expected | Actual | Pass/Fail | Примечание |
|----------|----------|--------|-----------|------------|
| ... | ... | ... | ... | ... |

→ Итог: GREEN-результаты задокументированы.

### GR-4. Gate GREEN → REFACTOR

- [ ] .mdc файл создан со всеми обязательными секциями
- [ ] Scenario bank прогнан (все сценарии)
- [ ] Результаты задокументированы

**Переход:** «GREEN завершён. Переключитесь в **Debug Mode** для pressure testing и верификации.»

---

## Фаза 5: REFACTOR (Debug Mode)

**Текущее состояние:** GREEN пройден, .mdc файл создан и протестирован на scenario bank.

### REF-1. Pressure Scenarios (Anti-Rationalization)

→ Текущее состояние: GREEN-результаты готовы.

Проверить:
- Агент пропускает шаг workflow? (дать неполные данные)
- Агент додумывает отсутствующие данные вместо STOP? (дать кейс без ключевой информации)
- Агент игнорирует stop conditions? (дать кейс, где должен остановиться)
- Агент обходит антипаттерны? (дать кейс, провоцирующий антипаттерн)

Количество: Lightweight — 1-2 pressure scenarios, Full — 3+.

→ Итог: pressure testing завершён, рационализации зафиксированы (если найдены).

### REF-2. Compatibility Check (системные инструкции)

→ Текущее состояние: pressure testing завершён.

Проверить финальную версию .mdc:
- **Base Layer:** не нарушает принципы 1–10?
- **Mode Extensions:** инструкции не конфликтуют с режимами?
- **Orchestrator routing:** триггеры корректно распознаются, не перехватывают чужие запросы?

→ Итог: compatibility verified / issues found.

### REF-3. Iteration (Full Track: max 3 итерации)

→ Текущее состояние: pressure + compatibility результаты готовы.

- Если найдены новые рационализации → обновить антипаттерны в .mdc → повторить GREEN-2 для проблемных сценариев
- Если compatibility issues → скорректировать триггеры или маршрутизацию → повторить REF-2
- Если всё чисто → перейти к DEPLOY
- **Cap:** после 3-й итерации — deploy с accepted risks (зафиксировать нерешённые issues в scenario bank)

Для Lightweight: 1 итерация достаточна, если GREEN чисто.

→ Итог: workflow стабилен (или accepted risks задокументированы).

### REF-4. Gate REFACTOR → DEPLOY

- [ ] Pressure scenarios пройдены (нет новых рационализаций, или они закрыты)
- [ ] Compatibility check пройден
- [ ] Scenario bank полностью заполнен (RED + GREEN + REFACTOR результаты)
- [ ] Full Track: минимум 1 полная итерация REFACTOR выполнена

---

## Фаза 6: DEPLOY (Debug → Code)

**Текущее состояние:** REFACTOR пройден, workflow стабилен.

### DEP-1. Deployment Checklist (Debug Mode)

→ Текущее состояние: workflow прошёл REFACTOR.

**Полный checklist (Full Track)** — по шаблону `workflows/templates/deployment-checklist.md`.

**Сокращённый checklist (Lightweight):**
- [ ] .mdc файл содержит все обязательные секции (назначение, триггеры, маршрутизация, шаги, stop conditions, антипаттерны)
- [ ] Триггеры проверены через Orchestrator
- [ ] Маршрутизация корректна (таблица «Этап → Режим»)
- [ ] Stop conditions определены
- [ ] Self-check / верификация определена

→ Итог: checklist пройден.

### DEP-2. Memory Layer Update (Code Mode)

→ Текущее состояние: checklist пройден.

**Переход:** «Checklist пройден. Переключитесь в **Code Mode** для финализации.»

Обновить:
- `index.md` — добавить навигацию к новому workflow
- `definitions.md` — новые термины (если появились)
- `patterns.md` — паттерны, обнаруженные при R&D
- `lessons-learned.md` — наблюдения из WDL-цикла

→ Итог: memory layer обновлён.

### DEP-3. Финальная активация

→ Текущее состояние: checklist + memory обновлены.

- .mdc файл размещён в `.codeassistant/rules/`
- Подтверждение: workflow активен и распознаётся Orchestrator

→ Итог: workflow в production.

---

## Фаза UPDATE (справочная секция — continuous)

Эта фаза не запускается через meta-workflow целиком. Она активируется по триггерам обновления.

**Триггеры обновления:**
- Обнаружен новый edge case при использовании workflow
- Изменились внутренние политики (KB)
- Появилось новое наблюдение в lessons-learned
- Платформа обновилась (новые возможности/ограничения)

**Процесс:**
1. Зафиксировать триггер обновления
2. Добавить новый сценарий в scenario bank
3. Прогнать GREEN (сценарий с текущим workflow)
4. Если FAIL → mini-REFACTOR (исправить → проверить)
5. Обновить memory layer

---

## Stop Conditions

ОСТАНОВИСЬ и спроси пользователя, если:
- Нет контракта / scope statement на создаваемый workflow
- Scope недостаточен для определения триггеров или deliverable
- RED-фаза выявила проблемы, не покрываемые планом из DESIGN → вернуться к DESIGN
- Compatibility check обнаружил конфликт с Base Layer (принципы 1–10)
- Непонятно, какой трек применить (Lightweight / Full)
- Пользователь запрашивает пропуск фазы (объяснить, зачем фаза нужна; решение за пользователем)

---

## Антипаттерны

НЕ делай:
- **AP-1:** Не пропускай RED-фазу («workflow очевидный, зачем baseline?»). RED обязательна даже для Lightweight (min 2 сценария)
- **AP-2:** Не пиши workflow до RESEARCH («и так понятно, что нужно»). RESEARCH → scope + scenario bank ПЕРЕД design
- **AP-3:** Не ограничивайся одной итерацией REFACTOR для Full Track. Min 1 полная итерация
- **AP-4:** Не деплой без checklist. Пропускаются критические проверки (маршрутизация, триггеры)
- **AP-5:** Не создавай workflow без таблицы маршрутизации. Orchestrator не должен угадывать режим (Наблюдение 9)
- **AP-6:** Не копируй workflow из другого без адаптации. Каждый workflow проходит собственный RESEARCH
- **AP-7:** Не тестируй только happy path. Scenario bank включает 4 типа: positive, negative, edge, pressure
- **AP-8:** Не формулируй выводы как финальное заключение. Комплаенс-output = предварительный анализ для review специалистом (Принцип 10).

---

## Hard Constraints

1. **No workflow without RED phase** — нельзя создавать .mdc без baseline-тестирования
2. **No DESIGN without RESEARCH** — нельзя проектировать без scope и scenario bank
3. **Scenario bank обязателен** — min 3 сценария (Lightweight), 10+ (Full)
4. **Таблица маршрутизации обязательна** в каждом создаваемом workflow
5. **Compatibility check обязателен** перед DEPLOY
6. **SGR-структура обязательна** в каждом шаге создаваемого workflow (текущее состояние → инструкции → итог шага)

---

## Self-Check (перед завершением каждой фазы)

Модель проверяет:
- [ ] Gate текущей фазы пройден (все пункты)?
- [ ] Все шаги фазы выполнены (не пропущены)?
- [ ] «Итог шага» зафиксирован для каждого шага?
- [ ] Stop conditions проверены и не нарушены?
- [ ] Skill chaining инструкция дана пользователю (если переход в другой режим)?

---

## Формат результата

WDL-цикл производит следующие артефакты:

| Артефакт | Формат | Где сохранять |
|----------|--------|---------------|
| Workflow (.mdc) | .mdc файл с обязательными секциями | `.codeassistant/rules/workflow-{name}.mdc` |
| Scenario bank | .md файл по шаблону scenario-bank-template.md | `.codeassistant/scenarios/scenario-bank-{name}.md` |
| Deployment checklist (заполненный) | .md файл по шаблону deployment-checklist.md | `workflows/active/` (рабочий файл, не постоянный) |

Обновляемые файлы (не создаются, а дополняются):

| Файл | Что добавляется |
|------|-----------------|
| `index.md` | Строка навигации к новому workflow |
| `definitions.md` | Новые термины (если появились) |
| `patterns.md` | Паттерны, обнаруженные при R&D |
| `lessons-learned.md` | Наблюдения из WDL-цикла |
